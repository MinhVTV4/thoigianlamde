<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Hẹn giờ Thi thử Thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        button { transition: background-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s ease; border-radius: 0.375rem; }
        button:not(:disabled):hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        button:not(:disabled):active { transform: scale(0.98); box-shadow: none; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .stats-table th, .stats-table td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: left; vertical-align: middle; }
        .stats-table th { background-color: #f1f5f9; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; color: #475569; }
        .stats-table td { font-size: 0.875rem; color: #4a5568; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #ffffff; margin: 5% auto; padding: 25px; border: 1px solid #d1d5db; width: 90%; max-width: 700px; border-radius: 8px; position: relative; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); animation: slideInFromTop 0.3s ease-out; }
        @keyframes slideInFromTop { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-button { color: #9ca3af; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s ease; }
        .close-button:hover, .close-button:focus { color: #4b5563; text-decoration: none; }
        .table-container { overflow-x: auto; max-height: 400px; border: 1px solid #e5e7eb; border-radius: 0.375rem; }
        .table-filter-container { margin-top: 15px; margin-bottom: 8px; display: flex; justify-content: flex-end; align-items: center; }
        .table-filter-container label { margin-right: 8px; font-size: 0.875rem; color: #4b5563; white-space: nowrap; }
        .table-filter-select { padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.875rem; background-color: white; min-width: 150px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .table-filter-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .results-stats-table td { vertical-align: middle; }
        .label-select, .label-select-modal, #examLabelSelect, #subjectSelect { padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.875rem; cursor: pointer; min-width: 110px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; width: 100%; }
        #examLabelSelect { width: 100%; max-width: xs; margin-left: auto; margin-right: auto; display: block; }
        #examLabelSelect, #subjectSelect { background-color: white; }
        .label-select:focus, .label-select-modal:focus, #examLabelSelect:focus, #subjectSelect:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .too-slow { background-color: #fef3c7 !important; }
        .too-fast { background-color: #d1fae5 !important; }
        .too-slow select, .too-fast select { border-color: #fcd34d; }
        #progressBarContainer { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 10px; overflow: hidden; margin-top: 1rem; margin-bottom: 1rem; }
        #progressBar { background-color: #2563eb; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="text"]#newLabelInput:focus, input[type="text"]#newSubjectInput:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        #currentQuestionTimerDisplay { font-size: 1.125rem; color: #4b5563; margin-top: 0.25rem; }
        .management-list ul { list-style: none; padding: 0; }
        .management-list li { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e5e7eb; }
        .management-list li:last-child { border-bottom: none; }
        .management-list .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.875rem; padding: 2px 5px; margin-left: 8px; flex-shrink: 0; }
        .management-list .delete-btn:hover { color: #dc2626; text-decoration: underline; }
        .management-list .item-text { flex: 1; margin-right: 8px; word-break: break-word; }
        .color-square { display: inline-block; width: 0.75rem; height: 0.75rem; margin-right: 0.5rem; border-radius: 0.125rem; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-3xl">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-blue-600 mb-6">Ứng dụng Hẹn giờ Thi thử Thông minh</h1>

        <div id="mainContent">
            <div id="settings" class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-1">
                         <label for="subjectSelect" class="block text-sm font-medium text-gray-700">Môn thi:</label>
                         <button id="manageSubjectsButton" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium py-1">Quản lý</button>
                    </div>
                    <select id="subjectSelect" class="w-full"> </select>
                </div>
                <div> <label for="examNumberInput" class="block text-sm font-medium text-gray-700 mb-1">Đề số / Tên bài thi:</label> <input type="text" id="examNumberInput" placeholder="Ví dụ: Đề 1, Giữa kỳ" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"> </div>
                <div class="flex flex-col sm:flex-row gap-4"> <div class="flex-1"> <label for="totalTimeInput" class="block text-sm font-medium text-gray-700 mb-1">Tổng thời gian làm bài (phút):</label> <input type="number" id="totalTimeInput" value="60" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"> </div> <div class="flex-1"> <label for="totalQuestionsInput" class="block text-sm font-medium text-gray-700 mb-1">Tổng số câu hỏi:</label> <input type="number" id="totalQuestionsInput" value="50" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"> </div> </div>
                <button id="startButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4"> Bắt đầu làm bài </button>
                <div class="flex flex-col sm:flex-row gap-3 mt-3"> <button id="viewHistoryButton" class="w-full sm:w-auto flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Xem Lịch sử Thi </button> <button id="manageLabelsButton" class="w-full sm:w-auto flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4"> Quản lý Nhãn </button> </div>
            </div>

            <div id="examArea" class="hidden space-y-4">
                 <div class="text-center mb-4 p-3 bg-blue-50 rounded-md border border-blue-200"> <p class="text-sm font-medium text-blue-800">Môn: <span id="currentSubjectDisplay" class="font-semibold"></span> - Đề: <span id="currentExamNumberDisplay" class="font-semibold"></span></p> </div> <div class="text-center"> <p class="text-lg font-medium text-gray-700">Thời gian còn lại:</p> <div id="timerDisplay" class="text-4xl md:text-5xl font-bold text-red-500 my-2">00:00:00</div> <p id="currentQuestionTimerDisplay" class="text-lg text-gray-600 mt-1">Thời gian câu này: <span id="currentQuestionTime">00:00</span></p> <p class="text-sm text-gray-500 mt-2">Đang làm câu: <span id="currentQuestionNumber" class="font-semibold">1</span> / <span id="totalQuestionsDisplay">?</span></p> <div id="progressBarContainer"> <div id="progressBar" style="width: 0%"></div> </div> </div> <div class="mt-4"> <label for="examLabelSelect" class="block text-sm font-medium text-gray-700 mb-1 text-center">Gán nhãn cho câu <span id="currentQuestionNumberLabel">1</span> (tùy chọn):</label> <select id="examLabelSelect" > </select> </div> <div class="flex flex-col sm:flex-row gap-3"> <button id="nextQuestionButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4"> Hoàn thành câu / Bài tiếp theo </button> <button id="endExamButton" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4"> Kết thúc bài thi </button> </div> <button id="pauseResumeButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 mt-3"> Tạm dừng </button>
            </div>

            <div id="resultsArea" class="hidden mt-6">
                 <h2 class="text-xl font-semibold text-center text-blue-600 mb-4">Kết quả làm bài</h2> <div class="text-center mb-4 p-3 bg-green-50 rounded-md border border-green-200"> <p class="text-sm font-medium text-green-800">Môn: <span id="resultSubjectDisplay" class="font-semibold"></span> - Đề: <span id="resultExamNumberDisplay" class="font-semibold"></span></p> <p class="text-sm text-gray-600 mt-1">Ngày thi: <span id="resultDateDisplay" class="font-medium"></span></p> </div> <div class="text-center mb-4 space-y-1 text-sm"> <p>Tổng thời gian làm bài: <span id="totalTimeTaken" class="font-medium"></span></p> <p class="text-gray-600">(Thời gian cài đặt: <span id="totalTimeSetDisplay"></span>, Tổng số câu cài đặt: <span id="totalQuestionsSetDisplay"></span>)</p> <p class="text-gray-800 font-medium">Thời gian trung bình/câu (đã làm): <span id="averageTimePerQuestionDisplay"></span></p> <p class="text-blue-700 font-medium">Thời gian mục tiêu/câu (theo cài đặt): <span id="targetTimePerQuestionDisplay"></span></p> </div> <h3 class="text-lg font-semibold text-gray-700 mb-2">Chi tiết thời gian từng câu</h3> <div class="table-filter-container"> <label for="resultsFilterLabelSelect">Lọc theo nhãn:</label> <select id="resultsFilterLabelSelect" class="table-filter-select"> </select> </div> <div class="table-container"> <table class="stats-table results-stats-table w-full border-collapse"> <thead> <tr> <th>Câu số</th> <th>Thời gian hoàn thành</th> <th>So với mục tiêu</th> <th>Nhãn</th> </tr> </thead> <tbody id="statsTableBody"> </tbody> </table> </div> <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Thống kê theo nhãn</h3> <div id="statsByLabelArea" class="space-y-1 text-sm text-gray-700 p-3 bg-gray-50 rounded-md border border-gray-200"> </div> <div class="flex flex-col sm:flex-row gap-3 mt-6"> <button id="restartButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4"> Làm bài thi khác </button> <button id="viewHistoryFromResultsButton" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Xem Lịch sử Thi </button> </div>
            </div>

            <div id="historyArea" class="hidden mt-6">
                 <h2 class="text-xl font-semibold text-center text-blue-600 mb-4">Lịch sử Thi</h2> <div class="table-container"> <table id="historyTable" class="stats-table w-full border-collapse"> <thead> <tr> <th>Ngày thi</th> <th>Môn thi</th> <th>Đề số</th> <th>Tổng thời gian</th> <th>Chi tiết</th> <th>Hành động</th> </tr> </thead> <tbody id="historyTableBody"> </tbody> </table> </div> <div class="mt-4 space-y-3"> <button id="exportHistoryButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4"> Xuất Lịch sử (JSON) </button> <button id="clearHistoryButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4"> Xóa Toàn Bộ Lịch Sử (KHÔNG THỂ HOÀN TÁC) </button> <button id="backToSettingsButton" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Quay lại Cài đặt </button> </div>
            </div>

             <div id="labelManagementArea" class="hidden mt-6 management-list">
                 <h2 class="text-xl font-semibold text-center text-indigo-600 mb-4">Quản lý Nhãn Tùy chỉnh</h2> <div class="mb-4"> <label for="newLabelInput" class="block text-sm font-medium text-gray-700 mb-1">Thêm nhãn mới:</label> <div class="flex gap-2"> <input type="text" id="newLabelInput" placeholder="Nhập tên nhãn..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"> <button id="addLabelButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4"> Thêm </button> </div> </div> <h3 class="text-lg font-semibold text-gray-700 mb-2">Các nhãn tùy chỉnh hiện có:</h3> <div class="bg-gray-50 p-3 rounded-md border border-gray-200 max-h-60 overflow-y-auto"> <ul id="customLabelsList"> <li class="italic text-gray-500 text-center" id="noCustomLabelsMessage">Chưa có nhãn tùy chỉnh nào.</li> </ul> </div> <button id="backToSettingsFromLabelsButton" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Quay lại Cài đặt </button>
            </div>

            <div id="subjectManagementArea" class="hidden mt-6 management-list">
                 <h2 class="text-xl font-semibold text-center text-teal-600 mb-4">Quản lý Môn thi</h2> <div class="mb-4"> <label for="newSubjectInput" class="block text-sm font-medium text-gray-700 mb-1">Thêm môn thi mới:</label> <div class="flex gap-2"> <input type="text" id="newSubjectInput" placeholder="Nhập tên môn thi..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"> <button id="addSubjectButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4"> Thêm </button> </div> </div> <h3 class="text-lg font-semibold text-gray-700 mb-2">Các môn thi đã tạo:</h3> <div class="bg-gray-50 p-3 rounded-md border border-gray-200 max-h-60 overflow-y-auto"> <ul id="subjectsList"> <li class="italic text-gray-500 text-center" id="noSubjectsMessage">Chưa có môn thi nào được tạo.</li> </ul> </div> <button id="backToSettingsFromSubjectsButton" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Quay lại Cài đặt </button>
            </div>

            <div id="historyDetailModal" class="modal">
                <div class="modal-content">
                    <span class="close-button" onclick="closeModal()">&times;</span>
                    <h3 class="text-lg font-semibold text-blue-600 mb-3" id="modalTitle">Chi tiết Bài thi</h3>
                    <div class="mb-3 text-sm space-y-1 border-b pb-3 border-gray-200"> <p><strong>Môn:</strong> <span id="modalSubject"></span></p> <p><strong>Đề:</strong> <span id="modalExamNumber"></span></p> <p><strong>Ngày thi:</strong> <span id="modalDate"></span></p> <p><strong>Tổng thời gian làm:</strong> <span id="modalTotalTimeTaken"></span></p> <p><strong>Thời gian cài đặt:</strong> <span id="modalTotalTimeSet"></span></p> <p><strong>Tổng số câu cài đặt:</strong> <span id="modalTotalQuestionsSet"></span></p> <p><strong>Thời gian mục tiêu/câu:</strong> <span id="modalTargetTimePerQuestion"></span></p> <p class="text-gray-800 font-medium"><strong>Thời gian trung bình/câu (đã làm):</strong> <span id="modalAverageTimePerQuestion"></span></p> </div>
                    <h4 class="text-base font-semibold text-gray-700 mb-2 mt-3">Thời gian từng câu:</h4>
                     <div class="table-filter-container"> <label for="modalFilterLabelSelect">Lọc theo nhãn:</label> <select id="modalFilterLabelSelect" class="table-filter-select"> </select> </div>
                     <div class="table-container"> <table class="stats-table w-full border-collapse"> <thead> <tr> <th>Câu số</th> <th>Thời gian hoàn thành</th> <th>So với mục tiêu</th> <th>Nhãn</th> </tr> </thead> <tbody id="modalStatsTableBody"> </tbody> </table> </div>
                    <h4 class="text-base font-semibold text-gray-700 mt-4 mb-2">Thống kê theo nhãn:</h4> <div id="modalStatsByLabelArea" class="space-y-1 text-sm text-gray-700 p-3 bg-gray-50 rounded-md border border-gray-200"> </div>
                </div>
            </div>

        </div> <div id="errorMessage" class="hidden mt-4 text-center text-red-600 bg-red-100 p-3 rounded-md border border-red-200"></div>
    </div> <script>
        // === DOM Elements ===
        const mainContentDiv = document.getElementById('mainContent');
        const settingsDiv = document.getElementById('settings');
        const examAreaDiv = document.getElementById('examArea');
        const resultsAreaDiv = document.getElementById('resultsArea');
        const historyAreaDiv = document.getElementById('historyArea');
        const labelManagementArea = document.getElementById('labelManagementArea');
        const subjectManagementArea = document.getElementById('subjectManagementArea'); // NEW
        const subjectSelect = document.getElementById('subjectSelect'); // NEW (replaces subjectInput)
        const examNumberInput = document.getElementById('examNumberInput');
        const totalTimeInput = document.getElementById('totalTimeInput');
        const totalQuestionsInput = document.getElementById('totalQuestionsInput');
        const startButton = document.getElementById('startButton');
        const viewHistoryButton = document.getElementById('viewHistoryButton');
        const viewHistoryFromResultsButton = document.getElementById('viewHistoryFromResultsButton');
        const manageLabelsButton = document.getElementById('manageLabelsButton');
        const manageSubjectsButton = document.getElementById('manageSubjectsButton'); // NEW
        const currentSubjectDisplay = document.getElementById('currentSubjectDisplay');
        const currentExamNumberDisplay = document.getElementById('currentExamNumberDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        const totalQuestionsDisplay = document.getElementById('totalQuestionsDisplay');
        const nextQuestionButton = document.getElementById('nextQuestionButton');
        const endExamButton = document.getElementById('endExamButton');
        const pauseResumeButton = document.getElementById('pauseResumeButton');
        const progressBar = document.getElementById('progressBar');
        const currentQuestionTimeSpan = document.getElementById('currentQuestionTime');
        const currentQuestionNumberLabel = document.getElementById('currentQuestionNumberLabel');
        const examLabelSelect = document.getElementById('examLabelSelect');
        const resultSubjectDisplay = document.getElementById('resultSubjectDisplay');
        const resultExamNumberDisplay = document.getElementById('resultExamNumberDisplay');
        const resultDateDisplay = document.getElementById('resultDateDisplay');
        const totalTimeTakenSpan = document.getElementById('totalTimeTaken');
        const totalTimeSetDisplay = document.getElementById('totalTimeSetDisplay');
        const totalQuestionsSetDisplay = document.getElementById('totalQuestionsSetDisplay');
        const averageTimePerQuestionDisplay = document.getElementById('averageTimePerQuestionDisplay');
        const targetTimePerQuestionDisplay = document.getElementById('targetTimePerQuestionDisplay');
        const statsTableBody = document.getElementById('statsTableBody');
        const statsByLabelArea = document.getElementById('statsByLabelArea');
        const restartButton = document.getElementById('restartButton');
        const resultsFilterLabelSelect = document.getElementById('resultsFilterLabelSelect');
        const historyTableBody = document.getElementById('historyTableBody');
        const backToSettingsButton = document.getElementById('backToSettingsButton');
        const exportHistoryButton = document.getElementById('exportHistoryButton');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const historyDetailModal = document.getElementById('historyDetailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubject = document.getElementById('modalSubject');
        const modalExamNumber = document.getElementById('modalExamNumber');
        const modalDate = document.getElementById('modalDate');
        const modalTotalTimeTaken = document.getElementById('modalTotalTimeTaken');
        const modalTotalTimeSet = document.getElementById('modalTotalTimeSet');
        const modalTotalQuestionsSet = document.getElementById('modalTotalQuestionsSet');
        const modalTargetTimePerQuestion = document.getElementById('modalTargetTimePerQuestion');
        const modalAverageTimePerQuestion = document.getElementById('modalAverageTimePerQuestion');
        const modalStatsTableBody = document.getElementById('modalStatsTableBody');
        const modalStatsByLabelArea = document.getElementById('modalStatsByLabelArea');
        const modalFilterLabelSelect = document.getElementById('modalFilterLabelSelect');
        const newLabelInput = document.getElementById('newLabelInput');
        const addLabelButton = document.getElementById('addLabelButton');
        const customLabelsList = document.getElementById('customLabelsList');
        const noCustomLabelsMessage = document.getElementById('noCustomLabelsMessage');
        const backToSettingsFromLabelsButton = document.getElementById('backToSettingsFromLabelsButton');
        const newSubjectInput = document.getElementById('newSubjectInput'); // NEW
        const addSubjectButton = document.getElementById('addSubjectButton'); // NEW
        const subjectsList = document.getElementById('subjectsList'); // NEW
        const noSubjectsMessage = document.getElementById('noSubjectsMessage'); // NEW
        const backToSettingsFromSubjectsButton = document.getElementById('backToSettingsFromSubjectsButton'); // NEW
        const errorMessageDiv = document.getElementById('errorMessage');

        // === State Variables ===
        let totalSecondsSet = 0, totalQuestionsSet = 0, secondsRemaining = 0, currentQuestionIndex = 1, pausedTime = 0, totalPauseDuration = 0, currentQuestionSeconds = 0;
        let timerInterval = null, questionStartTime = 0, examStartTime = 0, currentQuestionTimerInterval = null;
        let isPaused = false;
        let currentExamData = null;

        // === Constants ===
        const HISTORY_STORAGE_KEY = 'examTimerHistoryV4';
        const CUSTOM_LABELS_KEY = 'examTimerCustomLabelsV1';
        const SUBJECTS_KEY = 'examTimerSubjectsV1'; // NEW
        const DEFAULT_LABELS = ['Chưa gán', 'Dễ', 'Trung bình', 'Khó', 'Lý thuyết', 'Bài tập', 'Khác'];
        const DEFAULT_LABEL_COLORS = { 'Chưa gán': { bg: 'bg-gray-100', text: 'text-gray-800' }, 'Dễ': { bg: 'bg-green-100', text: 'text-green-800' }, 'Trung bình': { bg: 'bg-blue-100', text: 'text-blue-800' }, 'Khó': { bg: 'bg-red-100', text: 'text-red-800' }, 'Lý thuyết': { bg: 'bg-yellow-100', text: 'text-yellow-800' }, 'Bài tập': { bg: 'bg-purple-100', text: 'text-purple-800' }, 'Khác': { bg: 'bg-indigo-100', text: 'text-indigo-800' } };
        const CUSTOM_LABEL_COLOR_CYCLE = [ { bg: 'bg-pink-100', text: 'text-pink-800' }, { bg: 'bg-cyan-100', text: 'text-cyan-800' }, { bg: 'bg-orange-100', text: 'text-orange-800' }, { bg: 'bg-lime-100', text: 'text-lime-800' }, { bg: 'bg-teal-100', text: 'text-teal-800' }, { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800' }, { bg: 'bg-sky-100', text: 'text-sky-800' }, { bg: 'bg-rose-100', text: 'text-rose-800' } ];
        const FALLBACK_COLOR = { bg: 'bg-gray-100', text: 'text-gray-800' };
        const ALL_LABELS_FILTER_VALUE = "__ALL__";

        // === Utility Functions ===
        function formatTime(totalSeconds) { if (isNaN(totalSeconds) || totalSeconds < 0) totalSeconds = 0; const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = Math.floor(totalSeconds % 60); return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
        function formatTimeMMSS(totalSeconds) { if (isNaN(totalSeconds) || totalSeconds < 0) totalSeconds = 0; const minutes = Math.floor(totalSeconds / 60); const seconds = Math.floor(totalSeconds % 60); return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
        function formatTimeInSeconds(seconds) { if (isNaN(seconds) || seconds < 0) seconds = 0; const minutes = Math.floor(seconds / 60); const remainingSeconds = Math.floor(seconds % 60); if (minutes > 0) { return `${minutes}p ${remainingSeconds}s`; } else { return `${remainingSeconds}s`; } }
        function formatDate(date) { if (!date || !(date instanceof Date) || isNaN(date.getTime())) return 'N/A'; try { return date.toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'short' }); } catch (e) { console.error("Lỗi định dạng ngày:", e); return 'N/A'; } }
        function showError(message) { errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden'); if (errorMessageDiv.timeoutId) { clearTimeout(errorMessageDiv.timeoutId); } errorMessageDiv.timeoutId = setTimeout(() => { errorMessageDiv.classList.add('hidden'); errorMessageDiv.timeoutId = null; }, 5000); }
        function hideAllSections() { settingsDiv.classList.add('hidden'); examAreaDiv.classList.add('hidden'); resultsAreaDiv.classList.add('hidden'); historyAreaDiv.classList.add('hidden'); labelManagementArea.classList.add('hidden'); subjectManagementArea.classList.add('hidden'); }
        function showSettings() { clearInterval(timerInterval); clearInterval(currentQuestionTimerInterval); timerInterval = null; currentQuestionTimerInterval = null; isPaused = false; pausedTime = 0; totalPauseDuration = 0; examStartTime = 0; questionStartTime = 0; currentQuestionIndex = 1; currentExamData = null; secondsRemaining = 0; currentQuestionSeconds = 0; hideAllSections(); settingsDiv.classList.remove('hidden'); populateSubjectSelect(subjectSelect); errorMessageDiv.classList.add('hidden'); progressBar.style.width = '0%'; if(currentQuestionTimeSpan) currentQuestionTimeSpan.textContent = '00:00'; }

        // === Subject Management Functions === (NEW)
        function getSubjects() { const subjectsJson = localStorage.getItem(SUBJECTS_KEY); try { const subjects = subjectsJson ? JSON.parse(subjectsJson) : []; if (Array.isArray(subjects) && subjects.every(s => typeof s === 'string')) { return subjects.sort((a, b) => a.localeCompare(b)); } return []; } catch (e) { console.error("Lỗi đọc môn thi từ localStorage:", e); return []; } }
        function saveSubjects(subjectsArray) { try { if (Array.isArray(subjectsArray) && subjectsArray.every(s => typeof s === 'string')) { localStorage.setItem(SUBJECTS_KEY, JSON.stringify(subjectsArray)); } else { console.error("Attempted to save invalid subjects array:", subjectsArray); showError("Lỗi: Không thể lưu danh sách môn thi không hợp lệ."); } } catch (e) { console.error("Lỗi lưu môn thi vào localStorage:", e); showError("Không thể lưu môn thi. Bộ nhớ trình duyệt có thể đã đầy."); } }
        function addSubject() { const newSubject = newSubjectInput.value.trim(); if (!newSubject) { showError("Tên môn thi không được để trống."); return; } const currentSubjects = getSubjects(); if (currentSubjects.map(s => s.toLowerCase()).includes(newSubject.toLowerCase())) { showError(`Môn thi "${newSubject}" đã tồn tại.`); return; } currentSubjects.push(newSubject); saveSubjects(currentSubjects); populateSubjectsList(); populateSubjectSelect(subjectSelect); newSubjectInput.value = ''; showError(`Đã thêm môn thi "${newSubject}".`); }
        function deleteSubject(subjectToDelete) { let subjects = getSubjects(); const initialLength = subjects.length; subjects = subjects.filter(subject => subject !== subjectToDelete); if (subjects.length < initialLength) { saveSubjects(subjects); populateSubjectsList(); populateSubjectSelect(subjectSelect); showError(`Đã xóa môn thi "${subjectToDelete}". (Lưu ý: Lịch sử thi cũ sẽ không bị ảnh hưởng)`); } else { showError(`Không tìm thấy môn thi "${subjectToDelete}" để xóa.`); } }
        function populateSubjectsList() { const subjects = getSubjects(); subjectsList.innerHTML = ''; if (subjects.length === 0) { noSubjectsMessage.style.display = 'block'; } else { noSubjectsMessage.style.display = 'none'; subjects.forEach(subject => { const li = document.createElement('li'); li.innerHTML = `<span class="item-text">${subject}</span><button class="delete-btn delete-subject-btn" data-subject="${subject}">Xóa</button>`; subjectsList.appendChild(li); }); } }
        function showSubjectManagement() { hideAllSections(); subjectManagementArea.classList.remove('hidden'); populateSubjectsList(); newSubjectInput.value = ''; }
        function handleSubjectManagementListClick(e) { if (e.target && e.target.classList.contains('delete-subject-btn')) { const subjectToDelete = e.target.dataset.subject; if (subjectToDelete && confirm(`Bạn có chắc chắn muốn xóa môn thi "${subjectToDelete}" không?`)) { deleteSubject(subjectToDelete); } } }
        function populateSubjectSelect(selectElement) { const subjects = getSubjects(); const previouslySelected = selectElement.value; selectElement.innerHTML = '<option value="">-- Chọn môn thi --</option>'; subjects.forEach(subject => { const option = document.createElement('option'); option.value = subject; option.textContent = subject; if (subject === previouslySelected) { option.selected = true; } selectElement.appendChild(option); }); selectElement.disabled = subjects.length === 0; if (subjects.length === 0) { showError("Chưa có môn thi nào. Vui lòng vào 'Quản lý Môn thi' để thêm."); } }

        // === Custom Label Management ===
        function getCustomLabels() { const labelsJson = localStorage.getItem(CUSTOM_LABELS_KEY); try { const labels = labelsJson ? JSON.parse(labelsJson) : []; if (Array.isArray(labels) && labels.every(l => typeof l === 'string')) { return labels; } return []; } catch (e) { console.error("Lỗi đọc nhãn tùy chỉnh từ localStorage:", e); return []; } }
        function saveCustomLabels(labelsArray) { try { if (Array.isArray(labelsArray) && labelsArray.every(l => typeof l === 'string')) { localStorage.setItem(CUSTOM_LABELS_KEY, JSON.stringify(labelsArray)); } else { console.error("Attempted to save invalid custom labels array:", labelsArray); showError("Lỗi: Không thể lưu danh sách nhãn không hợp lệ."); } } catch (e) { console.error("Lỗi lưu nhãn tùy chỉnh vào localStorage:", e); showError("Không thể lưu nhãn tùy chỉnh. Bộ nhớ trình duyệt có thể đã đầy."); } }
        function getAllLabels() { const customLabels = getCustomLabels(); const all = [...DEFAULT_LABELS, ...customLabels.filter(l => !DEFAULT_LABELS.includes(l))]; return all; }
        function showLabelManagement() { hideAllSections(); labelManagementArea.classList.remove('hidden'); populateCustomLabelsList(); newLabelInput.value = ''; }
        function populateCustomLabelsList() { const customLabels = getCustomLabels(); customLabelsList.innerHTML = ''; if (customLabels.length === 0) { noCustomLabelsMessage.style.display = 'block'; } else { noCustomLabelsMessage.style.display = 'none'; customLabels.forEach(label => { const li = document.createElement('li'); li.innerHTML = `<span class="item-text">${label}</span><button class="delete-btn delete-label-btn" data-label="${label}">Xóa</button>`; customLabelsList.appendChild(li); }); } }
        function addCustomLabel() { const newLabel = newLabelInput.value.trim(); if (!newLabel) { showError("Tên nhãn không được để trống."); return; } const currentLabels = getCustomLabels(); const allLabels = getAllLabels(); if (allLabels.map(l => l.toLowerCase()).includes(newLabel.toLowerCase())) { showError(`Nhãn "${newLabel}" đã tồn tại.`); return; } currentLabels.push(newLabel); saveCustomLabels(currentLabels); populateCustomLabelsList(); newLabelInput.value = ''; showError(`Đã thêm nhãn "${newLabel}".`); }
        function deleteCustomLabel(labelToDelete) { let customLabels = getCustomLabels(); const initialLength = customLabels.length; customLabels = customLabels.filter(label => label !== labelToDelete); if (customLabels.length < initialLength) { saveCustomLabels(customLabels); populateCustomLabelsList(); showError(`Đã xóa nhãn "${labelToDelete}".`); } else { showError(`Không tìm thấy nhãn "${labelToDelete}" để xóa.`); } }
        function getLabelStyleClasses(labelName) { if (DEFAULT_LABEL_COLORS[labelName]) { return DEFAULT_LABEL_COLORS[labelName]; } const customLabels = getCustomLabels(); const index = customLabels.indexOf(labelName); if (index !== -1 && CUSTOM_LABEL_COLOR_CYCLE.length > 0) { return CUSTOM_LABEL_COLOR_CYCLE[index % CUSTOM_LABEL_COLOR_CYCLE.length]; } return FALLBACK_COLOR; }
        function populateLabelDropdown(selectElement, defaultSelectedValue = 'Chưa gán') { const allLabels = getAllLabels(); selectElement.innerHTML = ''; allLabels.forEach(label => { const option = document.createElement('option'); option.value = label; option.textContent = label; if (label === defaultSelectedValue) { option.selected = true; } selectElement.appendChild(option); }); const styleClasses = getLabelStyleClasses(defaultSelectedValue); if (selectElement.id === 'examLabelSelect') { selectElement.className = `w-full max-w-xs mx-auto block ${styleClasses.bg} ${styleClasses.text}`; selectElement.removeEventListener('change', handleExamLabelChange); selectElement.addEventListener('change', handleExamLabelChange); } }
        function handleExamLabelChange(e) { const selectElement = e.target; const newLabel = selectElement.value; const styleClasses = getLabelStyleClasses(newLabel); selectElement.className = `w-full max-w-xs mx-auto block ${styleClasses.bg} ${styleClasses.text}`; }

        // === Core Exam Logic ===
        function updateTimer() { if (isPaused || !examStartTime) return; const now = Date.now(); const elapsedSeconds = Math.floor((now - examStartTime - totalPauseDuration) / 1000); secondsRemaining = totalSecondsSet - elapsedSeconds; if (secondsRemaining < 0) { secondsRemaining = 0; } timerDisplay.textContent = formatTime(secondsRemaining); if (totalSecondsSet > 0) { const percentage = Math.max(0, Math.min(100, (elapsedSeconds / totalSecondsSet) * 100)); progressBar.style.width = `${percentage}%`; } else { progressBar.style.width = '0%'; } if (secondsRemaining <= 0) { timerDisplay.textContent = formatTime(0); progressBar.style.width = '100%'; showError("Hết giờ làm bài!"); endExam(); timerDisplay.classList.remove('text-red-500', 'text-orange-500'); timerDisplay.classList.add('text-gray-500'); } else if (secondsRemaining <= 10 * 60) { timerDisplay.classList.remove('text-red-500', 'text-gray-500'); timerDisplay.classList.add('text-orange-500'); } else { timerDisplay.classList.remove('text-orange-500', 'text-gray-500'); timerDisplay.classList.add('text-red-500'); } }
        function updateCurrentQuestionTimer() { if (isPaused || !examStartTime) return; currentQuestionSeconds++; currentQuestionTimeSpan.textContent = formatTimeMMSS(currentQuestionSeconds); }
        function startExam() { const subject = subjectSelect.value; const examNumber = examNumberInput.value.trim(); const totalMinutes = parseInt(totalTimeInput.value); const totalQs = parseInt(totalQuestionsInput.value); if (!subject) { showError("Vui lòng chọn Môn thi."); return; } if (!examNumber) { showError("Vui lòng nhập Đề số / Tên bài thi."); return; } if (isNaN(totalMinutes) || totalMinutes <= 0) { showError("Vui lòng nhập tổng thời gian hợp lệ (lớn hơn 0 phút)."); return; } if (isNaN(totalQs) || totalQs <= 0) { showError("Vui lòng nhập tổng số câu hỏi hợp lệ (lớn hơn 0 câu)."); return; } totalSecondsSet = totalMinutes * 60; totalQuestionsSet = totalQs; secondsRemaining = totalSecondsSet; currentQuestionIndex = 1; isPaused = false; pausedTime = 0; totalPauseDuration = 0; currentQuestionSeconds = 0; errorMessageDiv.classList.add('hidden'); progressBar.style.width = '0%'; currentExamData = { id: Date.now(), subject: subject, examNumber: examNumber, date: new Date(), totalTimeSet: totalSecondsSet, totalQuestionsSet: totalQuestionsSet, totalTimeTaken: 0, questionTimes: [] }; hideAllSections(); examAreaDiv.classList.remove('hidden'); currentSubjectDisplay.textContent = subject; currentExamNumberDisplay.textContent = examNumber; timerDisplay.textContent = formatTime(totalSecondsSet); timerDisplay.classList.remove('text-orange-500', 'text-gray-500'); timerDisplay.classList.add('text-red-500'); currentQuestionNumberSpan.textContent = currentQuestionIndex; totalQuestionsDisplay.textContent = totalQuestionsSet; currentQuestionTimeSpan.textContent = '00:00'; currentQuestionNumberLabel.textContent = currentQuestionIndex; populateLabelDropdown(examLabelSelect, 'Chưa gán'); if (totalQuestionsSet <= 0) { nextQuestionButton.disabled = true; endExamButton.disabled = true; pauseResumeButton.disabled = true; examLabelSelect.disabled = true; } else { nextQuestionButton.disabled = false; endExamButton.disabled = false; pauseResumeButton.disabled = false; pauseResumeButton.textContent = 'Tạm dừng'; pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600'); pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600'); examLabelSelect.disabled = false; } if (totalQuestionsSet === 1) { nextQuestionButton.textContent = "Hoàn thành câu cuối"; } else { nextQuestionButton.textContent = "Hoàn thành câu / Bài tiếp theo"; } const now = Date.now(); examStartTime = now; questionStartTime = now; if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimer, 1000); updateTimer(); if (currentQuestionTimerInterval) clearInterval(currentQuestionTimerInterval); currentQuestionTimerInterval = setInterval(updateCurrentQuestionTimer, 1000); updateCurrentQuestionTimer(); }
        function nextQuestion() { if (isPaused) { showError("Vui lòng tiếp tục bài thi trước khi chuyển câu."); return; } if (currentQuestionIndex > totalQuestionsSet) { showError(`Đã hoàn thành đủ ${totalQuestionsSet} câu.`); nextQuestionButton.disabled = true; return; } const now = Date.now(); const timeSpent = currentQuestionSeconds; const selectedLabel = examLabelSelect.value; if (currentExamData) { currentExamData.questionTimes.push({ time: timeSpent, label: selectedLabel, questionNumber: currentQuestionIndex }); } else { console.error("currentExamData is null when trying to save question time."); return; } currentQuestionSeconds = 0; currentQuestionTimeSpan.textContent = '00:00'; populateLabelDropdown(examLabelSelect, 'Chưa gán'); if (currentQuestionIndex === totalQuestionsSet) { endExam(); return; } currentQuestionIndex++; currentQuestionNumberSpan.textContent = currentQuestionIndex; currentQuestionNumberLabel.textContent = currentQuestionIndex; questionStartTime = now; if (currentQuestionIndex === totalQuestionsSet) { nextQuestionButton.textContent = "Hoàn thành câu cuối"; } else { nextQuestionButton.textContent = "Hoàn thành câu / Bài tiếp theo"; } }
        function confirmAndEndExam() { if (examStartTime > 0 || isPaused) { if (confirm("Bạn có chắc chắn muốn kết thúc bài thi?")) { endExam(); } } else { console.log("Không có bài thi nào đang diễn ra để kết thúc."); } }
        function endExam() { if (!examStartTime && !isPaused) { console.log("Bài thi đã kết thúc hoặc chưa bắt đầu."); return; } clearInterval(timerInterval); clearInterval(currentQuestionTimerInterval); timerInterval = null; currentQuestionTimerInterval = null; nextQuestionButton.disabled = true; endExamButton.disabled = true; pauseResumeButton.disabled = true; examLabelSelect.disabled = true; const endTime = isPaused ? pausedTime : Date.now(); if (examStartTime > 0 && currentExamData && currentExamData.questionTimes.length < currentQuestionIndex) { const lastQuestionTimeSpent = currentQuestionSeconds; const lastSelectedLabel = examLabelSelect.value; if (!currentExamData.questionTimes.some(q => q.questionNumber === currentQuestionIndex)) { currentExamData.questionTimes.push({ time: lastQuestionTimeSpent, label: lastSelectedLabel, questionNumber: currentQuestionIndex }); } } const totalTimeSpentSeconds = examStartTime > 0 ? Math.max(0, Math.floor((endTime - examStartTime - totalPauseDuration) / 1000)) : 0; if (currentExamData) { currentExamData.totalTimeTaken = totalTimeSpentSeconds; } else { console.error("currentExamData is null when trying to finalize exam data."); showError("Lỗi: Không thể lưu dữ liệu bài thi."); showSettings(); return; } if (totalSecondsSet > 0) { const finalPercentage = Math.max(0, Math.min(100, (currentExamData.totalTimeTaken / totalSecondsSet) * 100)); progressBar.style.width = `${finalPercentage}%`; } else { progressBar.style.width = '100%'; } saveExamToHistory(currentExamData); displayResults(currentExamData); hideAllSections(); resultsAreaDiv.classList.remove('hidden'); examStartTime = 0; questionStartTime = 0; isPaused = false; pausedTime = 0; totalPauseDuration = 0; currentQuestionSeconds = 0; }
        function togglePauseResume() { if (!examStartTime) { showError("Bài thi chưa bắt đầu."); return; } if (timerInterval === null && currentQuestionTimerInterval === null && !isPaused) { showError("Bài thi đã kết thúc."); return; } const now = Date.now(); if (isPaused) { isPaused = false; const currentPauseDuration = now - pausedTime; totalPauseDuration += currentPauseDuration; pausedTime = 0; pauseResumeButton.textContent = 'Tạm dừng'; pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600'); pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600'); if (currentQuestionIndex <= totalQuestionsSet) { nextQuestionButton.disabled = false; } endExamButton.disabled = false; examLabelSelect.disabled = false; updateTimer(); if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimer, 1000); updateCurrentQuestionTimer(); if (currentQuestionTimerInterval) clearInterval(currentQuestionTimerInterval); currentQuestionTimerInterval = setInterval(updateCurrentQuestionTimer, 1000); } else { isPaused = true; pausedTime = now; clearInterval(timerInterval); clearInterval(currentQuestionTimerInterval); timerInterval = null; currentQuestionTimerInterval = null; pauseResumeButton.textContent = 'Tiếp tục'; pauseResumeButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600'); pauseResumeButton.classList.add('bg-green-500', 'hover:bg-green-600'); nextQuestionButton.disabled = true; endExamButton.disabled = true; examLabelSelect.disabled = true; } }

        // === Filtering and Display ===
        function createLabelSelectHTML(currentLabel, ariaLabel, className = 'label-select') { const allLabels = getAllLabels(); const selectedLabel = allLabels.includes(currentLabel) ? currentLabel : 'Chưa gán'; const styleClasses = getLabelStyleClasses(selectedLabel); return ` <select class="${className} ${styleClasses.bg} ${styleClasses.text}" aria-label="${ariaLabel}"> ${allLabels.map(opt => `<option value="${opt}" ${selectedLabel === opt ? 'selected' : ''}>${opt}</option>`).join('')} </select> `; }
        function populateFilterDropdown(filterSelectElement, questionTimes) { filterSelectElement.innerHTML = ''; const allOption = document.createElement('option'); allOption.value = ALL_LABELS_FILTER_VALUE; allOption.textContent = 'Tất cả nhãn'; filterSelectElement.appendChild(allOption); if (!questionTimes || questionTimes.length === 0) { filterSelectElement.disabled = true; return; } const uniqueLabelsInResult = [...new Set(questionTimes.map(q => q.label || 'Chưa gán'))]; uniqueLabelsInResult.sort((a, b) => { if (a === 'Chưa gán') return -1; if (b === 'Chưa gán') return 1; const indexA = DEFAULT_LABELS.indexOf(a); const indexB = DEFAULT_LABELS.indexOf(b); if (indexA !== -1 && indexB !== -1) return indexA - indexB; if (indexA !== -1) return -1; if (indexB !== -1) return 1; return a.localeCompare(b); }); uniqueLabelsInResult.forEach(label => { if (label === 'Chưa gán' && uniqueLabelsInResult.length === 1) return; const option = document.createElement('option'); option.value = label; option.textContent = label; filterSelectElement.appendChild(option); }); filterSelectElement.disabled = uniqueLabelsInResult.length <= 1 && uniqueLabelsInResult[0] === 'Chưa gán'; filterSelectElement.value = ALL_LABELS_FILTER_VALUE; }
        function filterTableRows(tableBodyElement, selectedLabel) { const rows = tableBodyElement.querySelectorAll('tr'); rows.forEach(row => { if (selectedLabel === ALL_LABELS_FILTER_VALUE) { row.style.display = ''; } else { const labelSelect = row.querySelector('select'); const rowLabel = labelSelect ? labelSelect.value : null; row.style.display = (rowLabel === selectedLabel) ? '' : 'none'; } }); }
        function displayResults(examData) { if (!examData) { showError("Không có dữ liệu kết quả để hiển thị."); showSettings(); return; } resultSubjectDisplay.textContent = examData.subject || 'N/A'; resultExamNumberDisplay.textContent = examData.examNumber || 'N/A'; resultDateDisplay.textContent = formatDate(examData.date); totalTimeTakenSpan.textContent = formatTime(examData.totalTimeTaken); totalTimeSetDisplay.textContent = formatTime(examData.totalTimeSet); totalQuestionsSetDisplay.textContent = examData.totalQuestionsSet; const totalCompletedQuestions = examData.questionTimes?.length || 0; const averageTimePerQuestion = totalCompletedQuestions > 0 ? Math.round(examData.totalTimeTaken / totalCompletedQuestions) : 0; const targetTimePerQuestion = examData.totalQuestionsSet > 0 ? Math.round(examData.totalTimeSet / examData.totalQuestionsSet) : 0; averageTimePerQuestionDisplay.textContent = `${formatTimeInSeconds(averageTimePerQuestion)} (${averageTimePerQuestion} giây)`; targetTimePerQuestionDisplay.textContent = `${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion} giây)`; statsTableBody.innerHTML = ''; if (totalCompletedQuestions > 0) { examData.questionTimes.forEach((qTimeData) => { const questionNumber = qTimeData.questionNumber || 'N/A'; const timeTaken = qTimeData.time ?? 0; const label = qTimeData.label || 'Chưa gán'; const deviation = timeTaken - targetTimePerQuestion; const deviationText = targetTimePerQuestion > 0 ? (deviation >= 0 ? `+${formatTimeInSeconds(deviation)}` : `-${formatTimeInSeconds(Math.abs(deviation))}`) : 'N/A'; const deviationTooltip = targetTimePerQuestion > 0 ? `Mục tiêu: ${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion}s)` : ''; let rowClass = ''; if (targetTimePerQuestion > 0) { const percentDeviation = (deviation / targetTimePerQuestion) * 100; if (percentDeviation > 30) rowClass = 'too-slow'; else if (percentDeviation < -20) rowClass = 'too-fast'; } const row = document.createElement('tr'); if (rowClass) row.classList.add(rowClass); row.dataset.examId = examData.id; row.dataset.questionNumber = questionNumber; const selectHTML = createLabelSelectHTML(label, `Chọn nhãn cho câu ${questionNumber}`, 'label-select'); row.innerHTML = `<td>Câu ${questionNumber}</td><td>${formatTimeInSeconds(timeTaken)} (${timeTaken} giây)</td><td title="${deviationTooltip}">${deviationText}</td><td>${selectHTML}</td>`; const selectElement = row.querySelector('.label-select'); selectElement.addEventListener('change', (e) => { const newLabel = e.target.value; const examId = row.dataset.examId; const qNumber = parseInt(row.dataset.questionNumber); if (examId && !isNaN(qNumber)) { updateLabelInHistory(examId, qNumber, newLabel); const styleClasses = getLabelStyleClasses(newLabel); selectElement.className = `label-select ${styleClasses.bg} ${styleClasses.text}`; const updatedExamData = getExamFromHistory(examId); if (updatedExamData) { displayStatsByLabel(updatedExamData, statsByLabelArea); populateFilterDropdown(resultsFilterLabelSelect, updatedExamData.questionTimes); filterTableRows(statsTableBody, resultsFilterLabelSelect.value); } } }); statsTableBody.appendChild(row); }); } else { statsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3">Không có dữ liệu thời gian cho câu nào.</td></tr>'; } populateFilterDropdown(resultsFilterLabelSelect, examData.questionTimes); displayStatsByLabel(examData, statsByLabelArea); filterTableRows(statsTableBody, ALL_LABELS_FILTER_VALUE); }
        function displayStatsByLabel(examData, targetElement) { targetElement.innerHTML = ''; if (!examData || !examData.questionTimes || examData.questionTimes.length === 0) { targetElement.innerHTML = '<p class="text-center text-gray-500 italic text-sm py-2">Không có dữ liệu câu hỏi để thống kê.</p>'; return; } const stats = {}; let totalAssigned = 0; const allLabels = getAllLabels(); allLabels.forEach(lbl => { if (lbl !== 'Chưa gán') { stats[lbl] = { totalTime: 0, count: 0 }; } }); let unassignedStats = { totalTime: 0, count: 0 }; examData.questionTimes.forEach(qData => { const label = qData.label || 'Chưa gán'; const time = qData.time ?? 0; if (label === 'Chưa gán') { unassignedStats.totalTime += time; unassignedStats.count++; } else if (stats[label]) { stats[label].totalTime += time; stats[label].count++; totalAssigned++; } else { unassignedStats.totalTime += time; unassignedStats.count++; } }); if (totalAssigned === 0 && unassignedStats.count === examData.questionTimes.length) { targetElement.innerHTML = '<p class="text-center text-gray-500 italic text-sm py-2">Gán nhãn cho câu hỏi ở bảng trên để xem thống kê.</p>'; return; } const statsToDisplay = []; for (const label in stats) { if (stats[label].count > 0) { const average = Math.round(stats[label].totalTime / stats[label].count); statsToDisplay.push({ label: label, average: average, count: stats[label].count }); } } statsToDisplay.sort((a, b) => { const indexA = DEFAULT_LABELS.indexOf(a.label); const indexB = DEFAULT_LABELS.indexOf(b.label); if (indexA !== -1 && indexB !== -1) return indexA - indexB; if (indexA !== -1) return -1; if (indexB !== -1) return 1; return a.label.localeCompare(b.label); }); if (unassignedStats.count > 0) { const average = Math.round(unassignedStats.totalTime / unassignedStats.count); statsToDisplay.push({ label: 'Chưa gán', average: average, count: unassignedStats.count }); } statsToDisplay.forEach(item => { const styleClasses = getLabelStyleClasses(item.label); const p = document.createElement('p'); p.innerHTML = `<span class="color-square ${styleClasses.bg}"></span><span class="font-medium">${item.label}:</span> Trung bình ${formatTimeInSeconds(item.average)} (${item.average} giây) / ${item.count} câu`; targetElement.appendChild(p); }); }

        // === Quản lý Lịch sử ===
        function getHistory() { const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY); try { const history = historyJson ? JSON.parse(historyJson) : []; const currentAllLabels = getAllLabels(); return history.map(item => { if (item && item.id && item.date && typeof item.date === 'string') { const dateObj = new Date(item.date); if (!isNaN(dateObj.getTime())) { item.questionTimes = Array.isArray(item.questionTimes) ? item.questionTimes : []; item.questionTimes = item.questionTimes.map(q => ({ ...q, label: q.label && currentAllLabels.includes(q.label) ? q.label : 'Chưa gán' })); return { ...item, date: dateObj }; } } return null; }).filter(item => item !== null); } catch (e) { console.error("Lỗi đọc lịch sử từ localStorage:", e); showError("Lỗi đọc dữ liệu lịch sử. Dữ liệu có thể đã bị hỏng."); return []; } }
        function saveHistoryToStorage(historyArray) { try { const historyToSave = historyArray.map(item => ({ ...item, date: item.date instanceof Date ? item.date.toISOString() : item.date })); localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(historyToSave)); } catch (e) { console.error("Lỗi lưu lịch sử vào localStorage:", e); showError("Không thể lưu lịch sử. Bộ nhớ trình duyệt có thể đã đầy."); } }
        function saveExamToHistory(examData) { if (!examData || !examData.id || !(examData.date instanceof Date)) { console.error("Dữ liệu bài thi không hợp lệ để lưu:", examData); return; }; const history = getHistory(); const existingIndex = history.findIndex(item => item.id === examData.id); if (existingIndex === -1) { history.push(examData); } else { console.warn(`Bài thi ID ${examData.id} đã tồn tại. Ghi đè dữ liệu.`); history[existingIndex] = examData; } saveHistoryToStorage(history); }
        function getExamFromHistory(examId) { const history = getHistory(); const numericExamId = typeof examId === 'string' ? Number(examId) : examId; if (isNaN(numericExamId)) return null; return history.find(exam => exam.id === numericExamId) || null; }
        function updateLabelInHistory(examId, questionNumber, newLabel) { const history = getHistory(); const numericExamId = typeof examId === 'string' ? Number(examId) : examId; if (isNaN(numericExamId)) return; const examIndex = history.findIndex(exam => exam.id === numericExamId); if (examIndex === -1) { console.error(`Không tìm thấy bài thi ID ${numericExamId} trong lịch sử.`); return; } if (!Array.isArray(history[examIndex].questionTimes)) { console.error(`questionTimes không phải là mảng cho bài thi ID ${numericExamId}.`); history[examIndex].questionTimes = []; } const questionIndex = history[examIndex].questionTimes.findIndex(q => q.questionNumber === questionNumber); if (questionIndex === -1) { console.warn(`Không tìm thấy câu ${questionNumber} trong bài thi ${numericExamId}, không thể cập nhật nhãn.`); return; } if (history[examIndex].questionTimes[questionIndex].label !== newLabel) { history[examIndex].questionTimes[questionIndex].label = newLabel; saveHistoryToStorage(history); } }
        function deleteExamFromHistory(examId) { const numericExamId = typeof examId === 'string' ? Number(examId) : examId; if (isNaN(numericExamId)) return; let history = getHistory(); history = history.filter(exam => exam.id !== numericExamId); saveHistoryToStorage(history); console.log(`Đã xóa bài thi ID ${numericExamId} khỏi lịch sử.`); }
        function clearAllHistory() { const history = getHistory(); if (history.length === 0) { showError("Lịch sử đã trống."); return; } if (confirm("⚠️ CẢNH BÁO:\n\nBạn có chắc chắn muốn XÓA TOÀN BỘ lịch sử thi không?\nHành động này sẽ xóa vĩnh viễn tất cả dữ liệu đã lưu và KHÔNG THỂ HOÀN TÁC.")) { localStorage.removeItem(HISTORY_STORAGE_KEY); console.log("Đã xóa toàn bộ lịch sử thi."); displayHistory(); showError("Đã xóa toàn bộ lịch sử."); } }
        function exportHistory() { const history = getHistory(); if (history.length === 0) { showError("Không có lịch sử nào để xuất."); return; } const historyForExport = history.map(item => ({ ...item, date: item.date instanceof Date ? item.date.toISOString() : item.date })); const historyJson = JSON.stringify(historyForExport, null, 2); const blob = new Blob([historyJson], { type: 'application/json;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; const dateStr = new Date().toISOString().slice(0, 10); a.download = `lich_su_thi_thu_${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showError("Đã xuất lịch sử thành công."); }
        function displayHistory() { clearInterval(timerInterval); clearInterval(currentQuestionTimerInterval); timerInterval = null; currentQuestionTimerInterval = null; isPaused = false; pausedTime = 0; totalPauseDuration = 0; hideAllSections(); historyAreaDiv.classList.remove('hidden'); const history = getHistory(); historyTableBody.innerHTML = ''; if (history.length === 0) { historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4 italic">Chưa có lịch sử thi nào.</td></tr>`; return; } history.sort((a, b) => b.date.getTime() - a.date.getTime()); history.forEach(exam => { const examSubject = exam.subject || 'Không rõ môn'; const examNumber = exam.examNumber || 'Không rõ đề'; const examDate = formatDate(exam.date); const timeTaken = (exam.totalTimeTaken !== undefined && exam.totalTimeTaken !== null) ? formatTime(exam.totalTimeTaken) : 'N/A'; const row = document.createElement('tr'); row.classList.add('hover:bg-gray-50'); row.innerHTML = ` <td class="whitespace-nowrap">${examDate}</td> <td>${examSubject}</td> <td>${examNumber}</td> <td class="whitespace-nowrap">${timeTaken}</td> <td> <button class="text-blue-600 hover:text-blue-800 text-sm font-medium view-detail-btn" data-id="${exam.id}">Xem</button> </td> <td> <button class="text-red-600 hover:text-red-800 text-sm font-medium delete-history-btn" data-id="${exam.id}">Xóa</button> </td> `; historyTableBody.appendChild(row); }); }
        function handleHistoryTableClick(e) { const target = e.target; if (target && target.classList.contains('view-detail-btn')) { const examId = target.getAttribute('data-id'); if (examId) { showHistoryDetail(examId); } } else if (target && target.classList.contains('delete-history-btn')) { const examId = target.getAttribute('data-id'); if (examId) { const examData = getExamFromHistory(examId); const subject = examData?.subject || 'N/A'; const number = examData?.examNumber || 'N/A'; const date = formatDate(examData?.date); const confirmMsg = `Bạn có chắc chắn muốn xóa bài thi:\n\n"${subject} - ${number}"\n(Làm ngày: ${date})\n\nHành động này không thể hoàn tác.`; if (confirm(confirmMsg)) { deleteExamFromHistory(examId); displayHistory(); showError("Đã xóa bài thi khỏi lịch sử."); } } } }
        function showHistoryDetail(examId) { const examData = getExamFromHistory(examId); if (!examData) { showError("Không tìm thấy dữ liệu chi tiết cho bài thi này."); return; } modalTitle.textContent = `Chi tiết: ${examData.subject || 'N/A'} - ${examData.examNumber || 'N/A'}`; modalSubject.textContent = examData.subject || 'N/A'; modalExamNumber.textContent = examData.examNumber || 'N/A'; modalDate.textContent = formatDate(examData.date); modalTotalTimeTaken.textContent = formatTime(examData.totalTimeTaken); modalTotalTimeSet.textContent = formatTime(examData.totalTimeSet); modalTotalQuestionsSet.textContent = examData.totalQuestionsSet || 'N/A'; const targetTimePerQuestion = (examData.totalQuestionsSet > 0 && examData.totalTimeSet >= 0) ? Math.round(examData.totalTimeSet / examData.totalQuestionsSet) : 0; modalTargetTimePerQuestion.textContent = `${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion} giây)`; const totalCompletedQuestions = examData.questionTimes?.length || 0; const averageTimePerQuestion = totalCompletedQuestions > 0 ? Math.round(examData.totalTimeTaken / totalCompletedQuestions) : 0; modalAverageTimePerQuestion.textContent = `${formatTimeInSeconds(averageTimePerQuestion)} (${averageTimePerQuestion} giây)`; modalStatsTableBody.innerHTML = ''; if (totalCompletedQuestions > 0) { const sortedQuestions = [...examData.questionTimes].sort((a, b) => (a.questionNumber || 0) - (b.questionNumber || 0)); sortedQuestions.forEach((qTimeData) => { const questionNumber = qTimeData.questionNumber || 'N/A'; const timeTaken = qTimeData.time ?? 0; const label = qTimeData.label; const deviation = timeTaken - targetTimePerQuestion; const deviationText = targetTimePerQuestion > 0 ? (deviation >= 0 ? `+${formatTimeInSeconds(deviation)}` : `-${formatTimeInSeconds(Math.abs(deviation))}`) : 'N/A'; const deviationTooltip = targetTimePerQuestion > 0 ? `Mục tiêu: ${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion}s)` : ''; const row = document.createElement('tr'); row.dataset.examId = examData.id; row.dataset.questionNumber = questionNumber; const selectHTML = createLabelSelectHTML(label, `Chọn nhãn cho câu ${questionNumber} trong modal`, 'label-select-modal'); row.innerHTML = `<td>Câu ${questionNumber}</td><td>${formatTimeInSeconds(timeTaken)} (${timeTaken} giây)</td><td title="${deviationTooltip}">${deviationText}</td><td>${selectHTML}</td>`; modalStatsTableBody.appendChild(row); }); } else { modalStatsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3 italic">Không có dữ liệu thời gian câu hỏi.</td></tr>'; } populateFilterDropdown(modalFilterLabelSelect, examData.questionTimes); displayStatsByLabel(examData, modalStatsByLabelArea); filterTableRows(modalStatsTableBody, ALL_LABELS_FILTER_VALUE); historyDetailModal.style.display = "block"; document.body.style.overflow = 'hidden'; }
        function closeModal() { historyDetailModal.style.display = "none"; document.body.style.overflow = ''; }
        window.onclick = function(event) { if (event.target == historyDetailModal) { closeModal(); } }

        // === Event Listeners ===
        startButton.addEventListener('click', startExam); viewHistoryButton.addEventListener('click', displayHistory); nextQuestionButton.addEventListener('click', nextQuestion); endExamButton.addEventListener('click', confirmAndEndExam); pauseResumeButton.addEventListener('click', togglePauseResume); restartButton.addEventListener('click', showSettings); viewHistoryFromResultsButton.addEventListener('click', displayHistory); backToSettingsButton.addEventListener('click', showSettings); exportHistoryButton.addEventListener('click', exportHistory); clearHistoryButton.addEventListener('click', clearAllHistory);
        // Label Management
        manageLabelsButton.addEventListener('click', showLabelManagement); addLabelButton.addEventListener('click', addCustomLabel); backToSettingsFromLabelsButton.addEventListener('click', showSettings);
        customLabelsList.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('delete-label-btn')) { const labelToDelete = e.target.dataset.label; if (labelToDelete && confirm(`Bạn có chắc chắn muốn xóa nhãn "${labelToDelete}" không?`)) { deleteCustomLabel(labelToDelete); } } });
        // Subject Management (NEW)
        manageSubjectsButton.addEventListener('click', showSubjectManagement);
        addSubjectButton.addEventListener('click', addSubject);
        backToSettingsFromSubjectsButton.addEventListener('click', showSettings);
        subjectsList.addEventListener('click', handleSubjectManagementListClick); // Use delegation for delete buttons
        // History Table Click (Delegation - CORRECTED)
        historyTableBody.removeEventListener('click', handleHistoryTableClick); // Ensure no duplicates if script re-runs
        historyTableBody.addEventListener('click', handleHistoryTableClick); // Add the listener
        // Modal Label Select Change (Delegation)
        modalStatsTableBody.addEventListener('change', (e) => { if (e.target && e.target.classList.contains('label-select-modal')) { const selectElement = e.target; const row = selectElement.closest('tr'); if (!row) return; const newLabel = selectElement.value; const examId = row.dataset.examId; const qNumber = parseInt(row.dataset.questionNumber); if (examId && !isNaN(qNumber)) { updateLabelInHistory(examId, qNumber, newLabel); const styleClasses = getLabelStyleClasses(newLabel); selectElement.className = `label-select-modal ${styleClasses.bg} ${styleClasses.text}`; const updatedExamData = getExamFromHistory(examId); if (updatedExamData) { displayStatsByLabel(updatedExamData, modalStatsByLabelArea); populateFilterDropdown(modalFilterLabelSelect, updatedExamData.questionTimes); filterTableRows(modalStatsTableBody, modalFilterLabelSelect.value); } } else { console.error("Lỗi: Không lấy được examId hoặc questionNumber từ data attributes trong modal."); } } });
        // Filter Dropdown Listeners
        resultsFilterLabelSelect.addEventListener('change', (e) => { filterTableRows(statsTableBody, e.target.value); });
        modalFilterLabelSelect.addEventListener('change', (e) => { filterTableRows(modalStatsTableBody, e.target.value); });

        // === Initialization ===
        document.addEventListener('DOMContentLoaded', () => { showSettings(); });
    </script>
</body>
</html>
