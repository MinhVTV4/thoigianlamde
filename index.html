<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Hẹn giờ Thi thử Thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
             /* Light mode colors (default) */
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-accent: #3b82f6; /* blue-600 */
            --border-color: #e5e7eb; /* gray-200 */
            --table-header-bg: #f1f5f9; /* gray-100 */
            --input-border: #d1d5db; /* gray-300 */
            --input-focus-ring: rgba(59, 130, 246, 0.3);
            --modal-overlay: rgba(0,0,0,0.5);
            --highlight-slow: #fef3c7; /* yellow-100 */
            --highlight-fast: #d1fae5; /* green-100 */
            --highlight-average: #dbeafe; /* blue-100 */
            --info-bg: #eff6ff; /* blue-50 */
            --info-border: #bfdbfe; /* blue-200 */
            --info-text: #1e40af; /* blue-800 */
            --success-bg: #f0fdf4; /* green-50 */
            --success-border: #bbf7d0; /* green-200 */
            --success-text: #166534; /* green-800 */
            --error-bg: #fef2f2; /* red-50 */
            --error-border: #fecaca; /* red-200 */
            --error-text: #b91c1c; /* red-700 */
            --warning-timer-text: #f97316; /* orange-500 */
            --end-timer-text: #6b7280; /* gray-500 */
        }

        .dark {
            /* Dark mode colors */
            --bg-primary: #1f2937; /* gray-800 */
            --bg-secondary: #374151; /* gray-700 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #d1d5db; /* gray-300 */
            --text-accent: #60a5fa; /* blue-400 */
            --border-color: #4b5563; /* gray-600 */
            --table-header-bg: #4b5563; /* gray-600 */
            --input-border: #4b5563; /* gray-600 */
            --input-focus-ring: rgba(96, 165, 250, 0.4);
            --modal-overlay: rgba(0,0,0,0.7);
            --highlight-slow: #4f460a; /* Adjusted yellow */
            --highlight-fast: #064e3b; /* Adjusted green */
            --highlight-average: #1e40af; /* Adjusted blue */
            --info-bg: #1e3a8a; /* dark blue */
            --info-border: #1e40af; /* darker blue */
            --info-text: #dbeafe; /* light blue */
            --success-bg: #14532d; /* dark green */
            --success-border: #166534; /* darker green */
            --success-text: #dcfce7; /* light green */
            --error-bg: #7f1d1d; /* dark red */
            --error-border: #991b1b; /* darker red */
            --error-text: #fecaca; /* light red */
            --warning-timer-text: #fb923c; /* orange-400 */
            --end-timer-text: #9ca3af; /* gray-400 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Main container */
        .main-container {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Button styles */
        button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid transparent;
        }
        button:not(:disabled):hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        button:not(:disabled):active {
            transform: scale(0.98);
            box-shadow: none;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Specific button colors */
        .btn-primary { background-color: #3b82f6; color: white; } /* blue-500 */
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; } /* blue-600 */
        .btn-secondary { background-color: #6b7280; color: white; } /* gray-500 */
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; } /* gray-600 */
        .btn-success { background-color: #22c55e; color: white; } /* green-500 */
        .btn-success:hover:not(:disabled) { background-color: #16a34a; } /* green-600 */
        .btn-danger { background-color: #ef4444; color: white; } /* red-500 */
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; } /* red-600 */
        .btn-warning { background-color: #f59e0b; color: white; } /* yellow-500 */
        .btn-warning:hover:not(:disabled) { background-color: #d97706; } /* yellow-600 */
        .btn-purple { background-color: #8b5cf6; color: white; } /* purple-500 */
        .btn-purple:hover:not(:disabled) { background-color: #7c3aed; } /* purple-600 */
        .btn-danger-outline { background-color: transparent; color: #ef4444; border-color: #ef4444; }
        .btn-danger-outline:hover:not(:disabled) { background-color: var(--error-bg); }
        .btn-flag.flagged { background-color: #f59e0b; color: white; } /* Yellow when flagged */
        .btn-flag.flagged:hover:not(:disabled) { background-color: #d97706; }

        /* Table styles */
        .stats-table th, .stats-table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
            vertical-align: middle;
        }
        .stats-table th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
         .stats-table td {
             font-size: 0.875rem;
             color: var(--text-primary);
         }
         .stats-table tr:hover td {
             background-color: rgba(0, 0, 0, 0.02); /* Subtle hover for light mode */
         }
         .dark .stats-table tr:hover td {
             background-color: rgba(255, 255, 255, 0.05); /* Subtle hover for dark mode */
         }


        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-overlay);
            padding-top: 20px;
             animation: fadeIn 0.3s ease-out;
        }
         @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            margin: 5% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 700px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             animation: slideInFromTop 0.3s ease-out;
        }
         @keyframes slideInFromTop { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .close-button {
            color: var(--text-secondary);
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover, .close-button:focus {
            color: var(--text-primary);
            text-decoration: none;
        }

        /* Table container */
         .table-container {
             overflow-x: auto;
             max-height: 400px;
             margin-top: 15px;
             border: 1px solid var(--border-color);
             border-radius: 0.375rem;
         }

         /* Select dropdown styles */
         .label-select, .label-select-modal {
             padding: 4px 8px;
             border: 1px solid var(--input-border);
             border-radius: 4px;
             font-size: 0.875rem;
             background-color: var(--bg-secondary); /* Use secondary bg for inputs */
             color: var(--text-primary);
             cursor: pointer;
             min-width: 110px;
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
             transition: border-color 0.2s ease, box-shadow 0.2s ease;
         }
         .label-select:focus, .label-select-modal:focus {
             outline: none;
             border-color: var(--text-accent);
             box-shadow: 0 0 0 2px var(--input-focus-ring);
         }

         /* Highlighting rows */
         .too-slow { background-color: var(--highlight-slow); }
         .too-fast { background-color: var(--highlight-fast); }
         .average { background-color: var(--highlight-average); }

         /* Progress Bar */
         #progressBarContainer {
             width: 100%;
             background-color: var(--border-color);
             border-radius: 9999px;
             height: 10px;
             overflow: hidden;
             margin-top: 1rem;
             margin-bottom: 1rem;
         }
         #progressBar {
             background-color: var(--text-accent);
             height: 100%;
             border-radius: 9999px;
             transition: width 0.5s ease-in-out;
         }

         /* Input fields */
         input[type="text"], input[type="number"] {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
         }
         input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 2px var(--input-focus-ring);
         }

         /* Current Question Timer */
         #currentQuestionTimerDisplay {
             font-size: 1.125rem;
             color: var(--text-secondary);
             margin-top: 0.25rem;
         }
         .timer-warning { color: var(--warning-timer-text) !important; }
         .timer-ended { color: var(--end-timer-text) !important; }

         /* Info/Result boxes */
         .info-box {
             background-color: var(--info-bg);
             border: 1px solid var(--info-border);
             color: var(--info-text);
         }
         .success-box {
             background-color: var(--success-bg);
             border: 1px solid var(--success-border);
             color: var(--success-text);
         }
         .error-box {
            background-color: var(--error-bg);
            border: 1px solid var(--error-border);
            color: var(--error-text);
         }

         /* Flagged question indicator */
         .flag-indicator {
             color: #f59e0b; /* yellow-500 */
             margin-left: 4px;
             font-weight: bold;
         }

         /* Settings Toggles */
         .settings-toggle-group label {
             margin-right: 10px;
             color: var(--text-secondary);
         }
         .settings-toggle-group input[type="checkbox"] {
             margin-right: 4px;
             accent-color: var(--text-accent); /* Color the checkbox */
         }

         /* Chart Container */
         #chartContainer {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-secondary);
         }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="main-container bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-3xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-blue-600 flex-grow">Ứng dụng Hẹn giờ Thi thử Thông minh</h1>
            <div class="settings-toggle-group flex items-center text-sm">
                 <label for="darkModeToggle" class="flex items-center cursor-pointer" title="Chuyển đổi giao diện Sáng/Tối">
                     <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                     <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                     <span class="ms-2 text-xs font-medium text-gray-900 dark:text-gray-300">Tối</span>
                 </label>
                 <label for="soundToggle" class="ml-4 flex items-center cursor-pointer" title="Bật/Tắt âm thanh thông báo">
                     <input type="checkbox" id="soundToggle">
                     <span class="ms-1 text-xs font-medium text-gray-900 dark:text-gray-300">Âm</span>
                 </label>
            </div>
        </div>


        <div id="mainContent">
            <div id="settings" class="space-y-4">
                <div>
                    <label for="subjectInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Môn thi:</label>
                    <input type="text" id="subjectInput" placeholder="Ví dụ: Toán cao cấp" class="w-full px-3 py-2 border rounded-md shadow-sm">
                </div>
                <div>
                    <label for="examNumberInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Đề số / Tên bài thi:</label>
                    <input type="text" id="examNumberInput" placeholder="Ví dụ: Đề 1, Giữa kỳ" class="w-full px-3 py-2 border rounded-md shadow-sm">
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="totalTimeInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tổng thời gian làm bài (phút):</label>
                        <input type="number" id="totalTimeInput" value="60" min="1" class="w-full px-3 py-2 border rounded-md shadow-sm">
                    </div>
                     <div class="flex-1">
                        <label for="totalQuestionsInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tổng số câu hỏi:</label>
                        <input type="number" id="totalQuestionsInput" value="50" min="1" class="w-full px-3 py-2 border rounded-md shadow-sm">
                     </div>
                </div>

                <button id="startButton" class="w-full btn-primary font-bold py-2 px-4">
                    Bắt đầu làm bài
                </button>
                <button id="viewHistoryButton" class="mt-3 w-full btn-secondary font-bold py-2 px-4">
                    Xem Lịch sử Thi
                </button>
            </div>

            <div id="examArea" class="hidden space-y-4">
                <div class="text-center mb-4 p-3 info-box rounded-md">
                    <p class="text-sm font-medium">Môn: <span id="currentSubjectDisplay" class="font-semibold"></span> - Đề: <span id="currentExamNumberDisplay" class="font-semibold"></span></p>
                </div>
                <div class="text-center">
                    <p class="text-lg font-medium text-gray-700 dark:text-gray-300">Thời gian còn lại:</p>
                    <div id="timerDisplay" class="text-4xl md:text-5xl font-bold text-red-500 my-2">00:00:00</div>
                    <p id="currentQuestionTimerDisplay" class="text-lg text-gray-600 dark:text-gray-400 mt-1">Thời gian câu này: <span id="currentQuestionTime">00:00</span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Đang làm câu: <span id="currentQuestionNumber" class="font-semibold">1</span> / <span id="totalQuestionsDisplay">?</span></p>
                     <div id="progressBarContainer">
                         <div id="progressBar" style="width: 0%"></div>
                     </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="flagQuestionButton" title="Đánh dấu câu này (Phím tắt: F)" class="btn-secondary p-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 01-1-1V6zm7 4a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                        </svg>
                        Đánh dấu
                    </button>
                    <button id="nextQuestionButton" title="Phím tắt: Space / Enter" class="flex-1 btn-success font-bold py-2 px-4">
                        Hoàn thành câu / Bài tiếp theo
                    </button>
                    <button id="endExamButton" title="Phím tắt: Esc" class="flex-1 btn-danger font-bold py-2 px-4">
                        Kết thúc bài thi
                    </button>
                </div>
                <button id="pauseResumeButton" title="Phím tắt: P" class="w-full btn-warning font-bold py-2 px-4 mt-3">
                    Tạm dừng
                </button>
            </div>

            <div id="resultsArea" class="hidden mt-6">
                <h2 class="text-xl font-semibold text-center text-blue-600 dark:text-blue-400 mb-4">Kết quả làm bài</h2>
                <div class="text-center mb-4 p-3 success-box rounded-md">
                    <p class="text-sm font-medium">Môn: <span id="resultSubjectDisplay" class="font-semibold"></span> - Đề: <span id="resultExamNumberDisplay" class="font-semibold"></span></p>
                    <p class="text-sm mt-1">Ngày thi: <span id="resultDateDisplay" class="font-medium"></span></p>
                </div>
                <div class="text-center mb-4 space-y-1 text-sm">
                    <p>Tổng thời gian làm bài: <span id="totalTimeTaken" class="font-medium"></span></p>
                    <p class="text-gray-600 dark:text-gray-400">(Thời gian cài đặt: <span id="totalTimeSetDisplay"></span>, Tổng số câu cài đặt: <span id="totalQuestionsSetDisplay"></span>)</p>
                    <p class="font-medium">Thời gian trung bình/câu (đã làm): <span id="averageTimePerQuestionDisplay"></span></p>
                    <p class="text-blue-700 dark:text-blue-400 font-medium">Thời gian mục tiêu/câu (theo cài đặt): <span id="targetTimePerQuestionDisplay"></span></p>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Chi tiết thời gian từng câu</h3>
                <div class="table-container">
                    <table class="stats-table results-stats-table w-full border-collapse">
                        <thead>
                            <tr>
                                <th>Câu số</th>
                                <th>Thời gian hoàn thành</th>
                                <th>So với mục tiêu</th>
                                <th>Nhãn</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mt-6 mb-2">Thống kê theo nhãn</h3>
                <div id="statsByLabelArea" class="space-y-1 text-sm p-3 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600"></div>

                <div class="flex flex-col sm:flex-row gap-3 mt-6">
                    <button id="restartButton" class="flex-1 btn-primary font-bold py-2 px-4">
                        Làm bài thi khác
                    </button>
                    <button id="viewHistoryFromResultsButton" class="flex-1 btn-secondary font-bold py-2 px-4">
                        Xem Lịch sử Thi
                    </button>
                </div>
            </div>
        </div>

        <div id="historyArea" class="hidden mt-6">
             <h2 class="text-xl font-semibold text-center text-blue-600 dark:text-blue-400 mb-4">Lịch sử Thi</h2>
             <div class="table-container">
                 <table id="historyTable" class="stats-table w-full border-collapse">
                     <thead>
                         <tr>
                             <th>Ngày thi</th>
                             <th>Môn thi</th>
                             <th>Đề số</th>
                             <th>Tổng thời gian</th>
                             <th>Chi tiết</th>
                             <th>Hành động</th>
                         </tr>
                     </thead>
                     <tbody id="historyTableBody"></tbody>
                 </table>
             </div>
              <div class="mt-4 space-y-3">
                 <button id="viewChartsButton" class="w-full btn-primary font-bold py-2 px-4">
                     Xem Biểu đồ Thống kê
                 </button>
                 <button id="exportHistoryButton" class="w-full btn-purple font-bold py-2 px-4">
                     Xuất Lịch sử (JSON)
                 </button>
                 <button id="clearHistoryButton" class="w-full btn-danger-outline font-bold py-2 px-4">
                    Xóa Toàn Bộ Lịch Sử (KHÔNG THỂ HOÀN TÁC)
                 </button>
                 <button id="backToSettingsButton" class="w-full btn-secondary font-bold py-2 px-4">
                     Quay lại Cài đặt
                 </button>
              </div>
               <div id="chartContainer" class="hidden mt-6">
                   <h3 class="text-lg font-semibold text-center mb-4">Biểu đồ Thống kê</h3>
                   <canvas id="historyChart"></canvas>
                   <button id="closeChartButton" class="mt-4 w-full btn-secondary font-bold py-2 px-4">Đóng Biểu đồ</button>
               </div>
        </div>

        <div id="historyDetailModal" class="modal">
             <div class="modal-content">
                 <span class="close-button" onclick="closeModal()">&times;</span>
                 <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-3" id="modalTitle">Chi tiết Bài thi</h3>
                 <div class="mb-3 text-sm space-y-1 border-b pb-3 border-gray-200 dark:border-gray-600">
                     <p><strong>Môn:</strong> <span id="modalSubject"></span></p>
                     <p><strong>Đề:</strong> <span id="modalExamNumber"></span></p>
                     <p><strong>Ngày thi:</strong> <span id="modalDate"></span></p>
                     <p><strong>Tổng thời gian làm:</strong> <span id="modalTotalTimeTaken"></span></p>
                     <p><strong>Thời gian cài đặt:</strong> <span id="modalTotalTimeSet"></span></p>
                      <p><strong>Tổng số câu cài đặt:</strong> <span id="modalTotalQuestionsSet"></span></p>
                      <p><strong>Thời gian mục tiêu/câu:</strong> <span id="modalTargetTimePerQuestion"></span></p>
                      <p class="font-medium"><strong>Thời gian trung bình/câu (đã làm):</strong> <span id="modalAverageTimePerQuestion"></span></p>
                 </div>
                 <h4 class="text-base font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3">Thời gian từng câu:</h4>
                 <div class="table-container">
                     <table class="stats-table w-full border-collapse">
                         <thead>
                             <tr>
                                 <th>Câu số</th>
                                 <th>Thời gian hoàn thành</th>
                                  <th>So với mục tiêu</th>
                                 <th>Nhãn</th>
                             </tr>
                         </thead>
                         <tbody id="modalStatsTableBody"></tbody>
                     </table>
                 </div>
                 <h4 class="text-base font-semibold text-gray-700 dark:text-gray-300 mt-4 mb-2">Thống kê theo nhãn:</h4>
                  <div id="modalStatsByLabelArea" class="space-y-1 text-sm p-3 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600"></div>
             </div>
        </div>

        <div id="errorMessage" class="hidden mt-4 text-center p-3 rounded-md error-box"></div>
    </div>

    <script>
        // === DOM Elements ===
        const bodyElement = document.body;
        const mainContainer = document.querySelector('.main-container'); // For potential dark mode on container
        const mainContentDiv = document.getElementById('mainContent');

        // Screens
        const settingsDiv = document.getElementById('settings');
        const examAreaDiv = document.getElementById('examArea');
        const resultsAreaDiv = document.getElementById('resultsArea');
        const historyAreaDiv = document.getElementById('historyArea');
        const chartContainer = document.getElementById('chartContainer'); // NEW: Chart container

        // Settings Inputs & Buttons
        const subjectInput = document.getElementById('subjectInput');
        const examNumberInput = document.getElementById('examNumberInput');
        const totalTimeInput = document.getElementById('totalTimeInput');
        const totalQuestionsInput = document.getElementById('totalQuestionsInput');
        const startButton = document.getElementById('startButton');
        const viewHistoryButton = document.getElementById('viewHistoryButton');
        const darkModeToggle = document.getElementById('darkModeToggle'); // NEW: Dark mode toggle
        const soundToggle = document.getElementById('soundToggle'); // NEW: Sound toggle

        // Exam Area Elements
        const currentSubjectDisplay = document.getElementById('currentSubjectDisplay');
        const currentExamNumberDisplay = document.getElementById('currentExamNumberDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        const totalQuestionsDisplay = document.getElementById('totalQuestionsDisplay');
        const nextQuestionButton = document.getElementById('nextQuestionButton');
        const endExamButton = document.getElementById('endExamButton');
        const pauseResumeButton = document.getElementById('pauseResumeButton');
        const progressBar = document.getElementById('progressBar');
        const currentQuestionTimeSpan = document.getElementById('currentQuestionTime');
        const flagQuestionButton = document.getElementById('flagQuestionButton'); // NEW: Flag button

        // Results Area Elements
        const resultSubjectDisplay = document.getElementById('resultSubjectDisplay');
        const resultExamNumberDisplay = document.getElementById('resultExamNumberDisplay');
        const resultDateDisplay = document.getElementById('resultDateDisplay');
        const totalTimeTakenSpan = document.getElementById('totalTimeTaken');
        const totalTimeSetDisplay = document.getElementById('totalTimeSetDisplay');
        const totalQuestionsSetDisplay = document.getElementById('totalQuestionsSetDisplay');
        const averageTimePerQuestionDisplay = document.getElementById('averageTimePerQuestionDisplay');
        const targetTimePerQuestionDisplay = document.getElementById('targetTimePerQuestionDisplay');
        const statsTableBody = document.getElementById('statsTableBody');
        const statsByLabelArea = document.getElementById('statsByLabelArea');
        const restartButton = document.getElementById('restartButton');
        const viewHistoryFromResultsButton = document.getElementById('viewHistoryFromResultsButton');

        // History Area Elements
        const historyTableBody = document.getElementById('historyTableBody');
        const backToSettingsButton = document.getElementById('backToSettingsButton');
        const exportHistoryButton = document.getElementById('exportHistoryButton');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const viewChartsButton = document.getElementById('viewChartsButton'); // NEW: View charts button
        const closeChartButton = document.getElementById('closeChartButton'); // NEW: Close charts button
        const historyChartCanvas = document.getElementById('historyChart'); // NEW: Chart canvas

        // Modal Elements
        const historyDetailModal = document.getElementById('historyDetailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubject = document.getElementById('modalSubject');
        const modalExamNumber = document.getElementById('modalExamNumber');
        const modalDate = document.getElementById('modalDate');
        const modalTotalTimeTaken = document.getElementById('modalTotalTimeTaken');
        const modalTotalTimeSet = document.getElementById('modalTotalTimeSet');
        const modalTotalQuestionsSet = document.getElementById('modalTotalQuestionsSet');
        const modalTargetTimePerQuestion = document.getElementById('modalTargetTimePerQuestion');
        const modalAverageTimePerQuestion = document.getElementById('modalAverageTimePerQuestion');
        const modalStatsTableBody = document.getElementById('modalStatsTableBody');
        const modalStatsByLabelArea = document.getElementById('modalStatsByLabelArea');

        // Error Message
        const errorMessageDiv = document.getElementById('errorMessage');

        // === State Variables ===
        let totalSecondsSet = 0;
        let totalQuestionsSet = 0;
        let secondsRemaining = 0;
        let timerInterval = null;
        let questionStartTime = 0;
        let examStartTime = 0;
        let currentQuestionIndex = 1;
        let isPaused = false;
        let pausedTime = 0;
        let totalPauseDuration = 0;
        let currentQuestionTimerInterval = null;
        let currentQuestionSeconds = 0;
        let isCurrentQuestionFlagged = false; // NEW: Flag state for current question
        let currentExamData = null;
        let appSettings = { // NEW: App settings object
            darkMode: false,
            soundEnabled: false,
            lastSubject: '',
            lastExamNumber: '',
            lastTotalTime: 60,
            lastTotalQuestions: 50
        };
        let audioContext = null; // NEW: Audio Context for sound
        let historyChartInstance = null; // NEW: Chart instance

        // === Constants ===
        const HISTORY_STORAGE_KEY = 'examTimerHistoryV5'; // Updated version
        const SETTINGS_STORAGE_KEY = 'examTimerSettingsV1'; // NEW: Settings key
        const LABEL_OPTIONS = ['Chưa gán', 'Dễ', 'Trung bình', 'Khó', 'Lý thuyết', 'Bài tập', 'Khác'];
        const WARNING_TIMES = [600, 300, 60]; // Seconds remaining for warnings (10m, 5m, 1m)

        // === Utility Functions ===

        /** Formats total seconds to HH:MM:SS */
        function formatTime(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /** Formats total seconds to MM:SS */
        function formatTimeMMSS(totalSeconds) {
             if (isNaN(totalSeconds) || totalSeconds < 0) totalSeconds = 0;
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = Math.floor(totalSeconds % 60);
             return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /** Formats seconds to "Xp Ys" or "Ys" */
        function formatTimeInSeconds(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
             if (minutes > 0) {
                return `${minutes}p ${remainingSeconds}s`;
             } else {
                return `${remainingSeconds}s`;
             }
        }

        /** Formats Date object to local string */
        function formatDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return 'N/A';
            try {
                return date.toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'short' });
            } catch (e) {
                console.error("Lỗi định dạng ngày:", e);
                return 'N/A';
            }
        }

        /** Shows an error message */
        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            if (errorMessageDiv.timeoutId) clearTimeout(errorMessageDiv.timeoutId);
            errorMessageDiv.timeoutId = setTimeout(() => {
                errorMessageDiv.classList.add('hidden');
                errorMessageDiv.timeoutId = null;
            }, 5000);
        }

        /** Hides all main screen sections */
        function hideAllSections() {
            settingsDiv.classList.add('hidden');
            examAreaDiv.classList.add('hidden');
            resultsAreaDiv.classList.add('hidden');
            historyAreaDiv.classList.add('hidden');
            chartContainer.classList.add('hidden'); // Hide chart container too
        }

        // === Settings Management (NEW) ===

        /** Loads app settings from localStorage */
        function loadAppSettings() {
            const storedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
            if (storedSettings) {
                try {
                    appSettings = { ...appSettings, ...JSON.parse(storedSettings) };
                } catch (e) {
                    console.error("Lỗi đọc cài đặt:", e);
                    localStorage.removeItem(SETTINGS_STORAGE_KEY); // Clear corrupted settings
                }
            }
            applySettings(); // Apply loaded settings to UI
        }

        /** Saves current app settings to localStorage */
        function saveAppSettings() {
            try {
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(appSettings));
            } catch (e) {
                console.error("Lỗi lưu cài đặt:", e);
                showError("Không thể lưu cài đặt. Bộ nhớ có thể đã đầy.");
            }
        }

        /** Applies loaded settings to the UI elements */
        function applySettings() {
            // Dark Mode
            darkModeToggle.checked = appSettings.darkMode;
            if (appSettings.darkMode) {
                bodyElement.classList.add('dark');
            } else {
                bodyElement.classList.remove('dark');
            }
            // Sound
            soundToggle.checked = appSettings.soundEnabled;
            // Default Exam Settings
            subjectInput.value = appSettings.lastSubject || '';
            examNumberInput.value = appSettings.lastExamNumber || '';
            totalTimeInput.value = appSettings.lastTotalTime || 60;
            totalQuestionsInput.value = appSettings.lastTotalQuestions || 50;
        }

        /** Toggles dark mode */
        function toggleDarkMode() {
            appSettings.darkMode = darkModeToggle.checked;
            bodyElement.classList.toggle('dark', appSettings.darkMode);
            saveAppSettings();
            // NEW: Update chart colors if chart exists and is visible
             if (historyChartInstance && !chartContainer.classList.contains('hidden')) {
                 displayHistoryCharts(); // Re-render chart with new theme colors
             }
        }

        /** Toggles sound setting */
        function toggleSound() {
            appSettings.soundEnabled = soundToggle.checked;
            saveAppSettings();
            if (appSettings.soundEnabled) {
                // Initialize AudioContext on user interaction
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        console.log("AudioContext initialized.");
                    } catch (e) {
                        console.error("Web Audio API is not supported in this browser.", e);
                        showError("Trình duyệt không hỗ trợ âm thanh.");
                        appSettings.soundEnabled = false; // Disable sound if not supported
                        soundToggle.checked = false;
                        soundToggle.disabled = true;
                        saveAppSettings();
                    }
                }
                // Play a short sound to confirm activation
                playSound(880, 0.1, 'sine'); // A short beep
            }
        }

        // === Sound Playback (NEW) ===

        /**
         * Plays a simple sound using Web Audio API.
         * @param {number} frequency - Frequency in Hz (e.g., 440 for A4).
         * @param {number} duration - Duration in seconds.
         * @param {string} type - Oscillator type ('sine', 'square', 'sawtooth', 'triangle').
         */
        function playSound(frequency = 440, duration = 0.2, type = 'sine') {
            if (!appSettings.soundEnabled || !audioContext || audioContext.state === 'suspended') {
                // Attempt to resume context if suspended (often due to browser policy)
                if(audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log("AudioContext resumed successfully.");
                        // Try playing again after resume
                        if (appSettings.soundEnabled) _playSoundInternal(frequency, duration, type);
                    }).catch(e => console.error("Error resuming AudioContext:", e));
                }
                return; // Don't play if disabled or context not ready/resumed
            }
            _playSoundInternal(frequency, duration, type);
        }

        function _playSoundInternal(frequency, duration, type) {
             try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime); // Value in hertz

                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); // Start with volume
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration); // Fade out

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
             } catch (e) {
                  console.error("Error playing sound:", e);
             }
        }


        // === UI Navigation ===

        /** Shows the settings screen and resets state */
        function showSettings() {
            clearInterval(timerInterval);
            clearInterval(currentQuestionTimerInterval);
            timerInterval = null;
            currentQuestionTimerInterval = null;
            isPaused = false;
            pausedTime = 0;
            totalPauseDuration = 0;
            examStartTime = 0;
            questionStartTime = 0;
            currentQuestionIndex = 1;
            currentExamData = null;
            secondsRemaining = 0;
            currentQuestionSeconds = 0;
            isCurrentQuestionFlagged = false; // Reset flag state

            hideAllSections();
            settingsDiv.classList.remove('hidden');

            // Load last used settings from appSettings
            subjectInput.value = appSettings.lastSubject || '';
            examNumberInput.value = appSettings.lastExamNumber || '';
            totalTimeInput.value = appSettings.lastTotalTime || 60;
            totalQuestionsInput.value = appSettings.lastTotalQuestions || 50;

            errorMessageDiv.classList.add('hidden');
            progressBar.style.width = '0%';
            if(currentQuestionTimeSpan) currentQuestionTimeSpan.textContent = '00:00';
            // Reset flag button appearance
             if(flagQuestionButton) {
                flagQuestionButton.classList.remove('flagged');
                flagQuestionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 01-1-1V6zm7 4a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg> Đánh dấu`;
             }

        }

        // === Core Exam Logic ===

        /** Updates the main timer display and progress bar */
        function updateTimer() {
            if (isPaused || !examStartTime) return;

            const now = Date.now();
            const elapsedSeconds = Math.floor((now - examStartTime - totalPauseDuration) / 1000);
            secondsRemaining = totalSecondsSet - elapsedSeconds;

            if (secondsRemaining < 0) secondsRemaining = 0;

            timerDisplay.textContent = formatTime(secondsRemaining);
            timerDisplay.classList.remove('timer-warning', 'timer-ended'); // Reset color classes

             if (totalSecondsSet > 0) {
                const percentage = Math.max(0, Math.min(100, (elapsedSeconds / totalSecondsSet) * 100));
                progressBar.style.width = `${percentage}%`;
             } else {
                progressBar.style.width = '0%';
             }

            // Check for warnings and end time
            if (secondsRemaining <= 0) {
                timerDisplay.textContent = formatTime(0);
                progressBar.style.width = '100%';
                timerDisplay.classList.add('timer-ended');
                playSound(220, 0.5, 'square'); // Low beep for end
                showError("Hết giờ làm bài!");
                endExam();
            } else {
                 // Check warning times in descending order
                 for (const warningTime of WARNING_TIMES) {
                     if (secondsRemaining <= warningTime) {
                         timerDisplay.classList.add('timer-warning');
                         // Play sound only once when entering a warning threshold
                         if (!timerDisplay.dataset.warned || parseInt(timerDisplay.dataset.warned) > warningTime) {
                             playSound(880, 0.15, 'triangle'); // Higher pitch warning
                             timerDisplay.dataset.warned = warningTime.toString(); // Mark as warned for this level
                         }
                         break; // Apply only the highest applicable warning
                     }
                 }
                 if (!timerDisplay.classList.contains('timer-warning')) {
                      delete timerDisplay.dataset.warned; // Reset warned status if time increases (e.g., debug)
                 }
            }
        }

        /** Updates the current question timer */
        function updateCurrentQuestionTimer() {
            if (isPaused || !examStartTime) return;
            currentQuestionSeconds++;
            currentQuestionTimeSpan.textContent = formatTimeMMSS(currentQuestionSeconds);
        }

        /** Starts a new exam */
        function startExam() {
            const subject = subjectInput.value.trim();
            const examNumber = examNumberInput.value.trim();
            const totalMinutes = parseInt(totalTimeInput.value);
            const totalQs = parseInt(totalQuestionsInput.value);

            if (!subject) { showError("Vui lòng nhập Môn thi."); return; }
            if (!examNumber) { showError("Vui lòng nhập Đề số / Tên bài thi."); return; }
            if (isNaN(totalMinutes) || totalMinutes <= 0) { showError("Vui lòng nhập tổng thời gian hợp lệ."); return; }
            if (isNaN(totalQs) || totalQs <= 0) { showError("Vui lòng nhập tổng số câu hỏi hợp lệ."); return; }

            // Save settings for next time (NEW)
            appSettings.lastSubject = subject;
            appSettings.lastExamNumber = examNumber;
            appSettings.lastTotalTime = totalMinutes;
            appSettings.lastTotalQuestions = totalQs;
            saveAppSettings();

            // Initialize state
            totalSecondsSet = totalMinutes * 60;
            totalQuestionsSet = totalQs;
            secondsRemaining = totalSecondsSet;
            currentQuestionIndex = 1;
            isPaused = false;
            pausedTime = 0;
            totalPauseDuration = 0;
            currentQuestionSeconds = 0;
            isCurrentQuestionFlagged = false; // Reset flag state for new exam
            errorMessageDiv.classList.add('hidden');
            progressBar.style.width = '0%';
            timerDisplay.dataset.warned = '99999'; // Reset warning status

            currentExamData = {
                id: Date.now(), subject, examNumber, date: new Date(),
                totalTimeSet, totalQuestionsSet, totalTimeTaken: 0, questionTimes: []
            };

            // Update UI
            hideAllSections();
            examAreaDiv.classList.remove('hidden');
            currentSubjectDisplay.textContent = subject;
            currentExamNumberDisplay.textContent = examNumber;
            timerDisplay.textContent = formatTime(totalSecondsSet);
            timerDisplay.classList.remove('timer-warning', 'timer-ended');
            currentQuestionNumberSpan.textContent = currentQuestionIndex;
            totalQuestionsDisplay.textContent = totalQuestionsSet;
            currentQuestionTimeSpan.textContent = '00:00';
            flagQuestionButton.classList.remove('flagged'); // Reset flag button appearance
            flagQuestionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 01-1-1V6zm7 4a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg> Đánh dấu`;


            // Enable/disable buttons
            const buttonsEnabled = totalQuestionsSet > 0;
            nextQuestionButton.disabled = !buttonsEnabled;
            endExamButton.disabled = !buttonsEnabled;
            pauseResumeButton.disabled = !buttonsEnabled;
            flagQuestionButton.disabled = !buttonsEnabled; // Disable flag if no questions
            pauseResumeButton.textContent = 'Tạm dừng';
            pauseResumeButton.classList.remove('btn-success'); // Reset pause button style
            pauseResumeButton.classList.add('btn-warning');

            if (totalQuestionsSet === 1) nextQuestionButton.textContent = "Hoàn thành câu cuối";
            else nextQuestionButton.textContent = "Hoàn thành câu / Bài tiếp theo";

            // Start timers
            const now = Date.now();
            examStartTime = now;
            questionStartTime = now;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            if (currentQuestionTimerInterval) clearInterval(currentQuestionTimerInterval);
            currentQuestionTimerInterval = setInterval(updateCurrentQuestionTimer, 1000);
            updateTimer();
            updateCurrentQuestionTimer();
        }

        /** Handles moving to the next question */
        function nextQuestion() {
            if (isPaused || !currentExamData) return;
            if (currentQuestionIndex > totalQuestionsSet) {
                 showError(`Đã hoàn thành đủ ${totalQuestionsSet} câu.`);
                 nextQuestionButton.disabled = true;
                 return;
             }

            const now = Date.now();
            const timeSpent = currentQuestionSeconds; // Time from dedicated timer

            // Save current question data (including flag status)
            currentExamData.questionTimes.push({
                time: timeSpent,
                label: 'Chưa gán',
                questionNumber: currentQuestionIndex,
                flagged: isCurrentQuestionFlagged // NEW: Save flag status
            });

            // Reset for next question
            currentQuestionSeconds = 0;
            currentQuestionTimeSpan.textContent = '00:00';
            isCurrentQuestionFlagged = false; // Reset flag for the new question
            flagQuestionButton.classList.remove('flagged'); // Reset flag button appearance
            flagQuestionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 01-1-1V6zm7 4a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg> Đánh dấu`;


            if (currentQuestionIndex === totalQuestionsSet) {
                endExam();
                return;
            }

            currentQuestionIndex++;
            currentQuestionNumberSpan.textContent = currentQuestionIndex;
            questionStartTime = now; // Update start time for potential mid-question end

             if (currentQuestionIndex === totalQuestionsSet) {
                 nextQuestionButton.textContent = "Hoàn thành câu cuối";
             } else {
                 nextQuestionButton.textContent = "Hoàn thành câu / Bài tiếp theo";
             }
        }

        /** Confirms and ends the exam */
        function confirmAndEndExam() {
             if (examStartTime > 0 || isPaused) {
                 if (confirm("Bạn có chắc chắn muốn kết thúc bài thi?")) {
                     endExam();
                 }
             }
        }

        /** Ends the current exam */
        function endExam() {
             if (!examStartTime && !isPaused) return;

            // Stop timers
            clearInterval(timerInterval);
            clearInterval(currentQuestionTimerInterval);
            timerInterval = null;
            currentQuestionTimerInterval = null;

            // Disable buttons
            nextQuestionButton.disabled = true;
            endExamButton.disabled = true;
            pauseResumeButton.disabled = true;
            flagQuestionButton.disabled = true;

            const endTime = isPaused ? pausedTime : Date.now();

            // Record time for the last question if ended mid-question
             if (examStartTime > 0 && currentExamData && currentExamData.questionTimes.length < currentQuestionIndex) {
                const lastQuestionTimeSpent = currentQuestionSeconds;
                 if (!currentExamData.questionTimes.some(q => q.questionNumber === currentQuestionIndex)) {
                     currentExamData.questionTimes.push({
                        time: lastQuestionTimeSpent,
                        label: 'Chưa gán',
                        questionNumber: currentQuestionIndex,
                        flagged: isCurrentQuestionFlagged // Save flag status of the last question
                    });
                 }
            }

            // Calculate total time
            const totalTimeSpentSeconds = examStartTime > 0 ? Math.max(0, Math.floor((endTime - examStartTime - totalPauseDuration) / 1000)) : 0;
            if (currentExamData) currentExamData.totalTimeTaken = totalTimeSpentSeconds;
            else { showError("Lỗi lưu dữ liệu cuối cùng."); showSettings(); return; }

            // Final progress bar update
            progressBar.style.width = totalSecondsSet > 0 ? `${Math.max(0, Math.min(100, (totalTimeSpentSeconds / totalSecondsSet) * 100))}%` : '100%';

            // Save, display results, navigate
            saveExamToHistory(currentExamData);
            displayResults(currentExamData);
            hideAllSections();
            resultsAreaDiv.classList.remove('hidden');

            // Reset state variables (after saving/displaying)
            examStartTime = 0; questionStartTime = 0; isPaused = false; pausedTime = 0;
            totalPauseDuration = 0; currentQuestionSeconds = 0; isCurrentQuestionFlagged = false;
        }

        /** Toggles pause/resume state */
        function togglePauseResume() {
             if (!examStartTime) { showError("Bài thi chưa bắt đầu."); return; }
             if (timerInterval === null && currentQuestionTimerInterval === null && !isPaused) { showError("Bài thi đã kết thúc."); return; }

            const now = Date.now();
            if (isPaused) { // Resume
                isPaused = false;
                totalPauseDuration += (now - pausedTime);
                pausedTime = 0;

                pauseResumeButton.textContent = 'Tạm dừng';
                pauseResumeButton.classList.remove('btn-success');
                pauseResumeButton.classList.add('btn-warning');

                if (currentQuestionIndex <= totalQuestionsSet) nextQuestionButton.disabled = false;
                endExamButton.disabled = false;
                flagQuestionButton.disabled = false; // Re-enable flag button

                // Restart timers
                updateTimer();
                updateCurrentQuestionTimer();
                if (timerInterval) clearInterval(timerInterval);
                if (currentQuestionTimerInterval) clearInterval(currentQuestionTimerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                currentQuestionTimerInterval = setInterval(updateCurrentQuestionTimer, 1000);

            } else { // Pause
                isPaused = true;
                pausedTime = now;
                clearInterval(timerInterval);
                clearInterval(currentQuestionTimerInterval);
                timerInterval = null;
                currentQuestionTimerInterval = null;

                pauseResumeButton.textContent = 'Tiếp tục';
                pauseResumeButton.classList.remove('btn-warning');
                pauseResumeButton.classList.add('btn-success');

                nextQuestionButton.disabled = true;
                endExamButton.disabled = true;
                flagQuestionButton.disabled = true; // Disable flag button when paused
            }
        }

        /** NEW: Toggles the flag for the current question */
        function toggleFlagQuestion() {
            if (isPaused || !examStartTime || timerInterval === null) return; // Only allow flagging during active exam

            isCurrentQuestionFlagged = !isCurrentQuestionFlagged;
            flagQuestionButton.classList.toggle('flagged', isCurrentQuestionFlagged); // Toggle visual style
            // Update button text/icon (optional)
            if (isCurrentQuestionFlagged) {
                 flagQuestionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-3.5L5 18V4z" /></svg> Bỏ đánh dấu`;
            } else {
                 flagQuestionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 01-1-1V6zm7 4a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg> Đánh dấu`;
            }
            // console.log(`Câu ${currentQuestionIndex} đánh dấu: ${isCurrentQuestionFlagged}`);
        }


        // === Results Display ===

        /** Displays exam results */
        function displayResults(examData) {
             if (!examData) { showError("Không có dữ liệu kết quả."); showSettings(); return; }

            resultSubjectDisplay.textContent = examData.subject || 'N/A';
            resultExamNumberDisplay.textContent = examData.examNumber || 'N/A';
            resultDateDisplay.textContent = formatDate(examData.date);
            totalTimeTakenSpan.textContent = formatTime(examData.totalTimeTaken);
            totalTimeSetDisplay.textContent = formatTime(examData.totalTimeSet);
            totalQuestionsSetDisplay.textContent = examData.totalQuestionsSet;

            const totalCompletedQuestions = examData.questionTimes?.length || 0;
            const averageTimePerQuestion = totalCompletedQuestions > 0 ? Math.round(examData.totalTimeTaken / totalCompletedQuestions) : 0;
            const targetTimePerQuestion = examData.totalQuestionsSet > 0 ? Math.round(examData.totalTimeSet / examData.totalQuestionsSet) : 0;

            averageTimePerQuestionDisplay.textContent = `${formatTimeInSeconds(averageTimePerQuestion)} (${averageTimePerQuestion} giây)`;
            targetTimePerQuestionDisplay.textContent = `${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion} giây)`;

            statsTableBody.innerHTML = '';
            if (totalCompletedQuestions === 0) {
                statsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3 italic">Không có dữ liệu thời gian câu hỏi.</td></tr>';
            } else {
                 examData.questionTimes.forEach((qTimeData) => {
                    const questionNumber = qTimeData.questionNumber || 'N/A';
                    const timeTaken = qTimeData.time ?? 0;
                    const label = qTimeData.label || 'Chưa gán';
                    const isFlagged = qTimeData.flagged || false; // NEW: Check flag status

                    const deviation = timeTaken - targetTimePerQuestion;
                    const deviationText = targetTimePerQuestion > 0 ? (deviation >= 0 ? `+${formatTimeInSeconds(deviation)}` : `-${formatTimeInSeconds(Math.abs(deviation))}`) : 'N/A';
                    const deviationTooltip = targetTimePerQuestion > 0 ? `Mục tiêu: ${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion}s)` : '';

                     let rowClass = '';
                     if (targetTimePerQuestion > 0) {
                         const percentDeviation = (deviation / targetTimePerQuestion) * 100;
                          if (percentDeviation > 30) rowClass = 'too-slow';
                          else if (percentDeviation < -20) rowClass = 'too-fast';
                          else if (Math.abs(deviation) <= 5 && targetTimePerQuestion > 10) rowClass = 'average';
                     }

                    const row = document.createElement('tr');
                    if (rowClass) row.classList.add(rowClass);
                    row.dataset.examId = examData.id;
                    row.dataset.questionNumber = questionNumber;

                    // NEW: Add flag indicator if flagged
                    const flagHtml = isFlagged ? '<span class="flag-indicator" title="Đã đánh dấu">★</span>' : '';

                    row.innerHTML = `
                        <td>Câu ${questionNumber}${flagHtml}</td>
                        <td>${formatTimeInSeconds(timeTaken)} (${timeTaken} giây)</td>
                        <td title="${deviationTooltip}">${deviationText}</td>
                        <td>
                            <select class="label-select" aria-label="Chọn nhãn cho câu ${questionNumber}">
                                ${LABEL_OPTIONS.map(opt => `<option value="${opt}" ${label === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </td>
                    `;

                    const selectElement = row.querySelector('.label-select');
                    selectElement.addEventListener('change', (e) => {
                        const newLabel = e.target.value;
                        const examId = row.dataset.examId;
                        const qNumber = parseInt(row.dataset.questionNumber);
                        if (examId && !isNaN(qNumber)) {
                            updateLabelInHistory(examId, qNumber, newLabel);
                            const updatedExamData = getExamFromHistory(examId);
                            if (updatedExamData) displayStatsByLabel(updatedExamData, statsByLabelArea);
                        }
                    });
                    statsTableBody.appendChild(row);
                 });
            }
             displayStatsByLabel(examData, statsByLabelArea);
        }

        /** Displays statistics grouped by label */
        function displayStatsByLabel(examData, targetElement) {
             targetElement.innerHTML = '';
             if (!examData?.questionTimes?.length) {
                 targetElement.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 italic text-sm py-2">Không có dữ liệu câu hỏi.</p>';
                 return;
             }

             const stats = {};
             let totalAssigned = 0;
             examData.questionTimes.forEach(qData => {
                 const label = qData.label || 'Chưa gán';
                 if (!stats[label]) stats[label] = { totalTime: 0, count: 0 };
                 stats[label].totalTime += (qData.time ?? 0);
                 stats[label].count++;
                 if (label !== 'Chưa gán') totalAssigned++;
             });

              if (totalAssigned === 0 && stats['Chưa gán']?.count === examData.questionTimes.length) {
                 targetElement.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 italic text-sm py-2">Gán nhãn ở bảng trên để xem thống kê.</p>';
                 return;
              }

              const statsToDisplay = Object.entries(stats)
                  .filter(([, data]) => data.count > 0)
                  .map(([label, data]) => ({
                      label,
                      average: Math.round(data.totalTime / data.count),
                      count: data.count
                  }));

             statsToDisplay.sort((a, b) => {
                 const order = ['Dễ', 'Trung bình', 'Khó', 'Lý thuyết', 'Bài tập', 'Khác', 'Chưa gán'];
                 const indexA = order.indexOf(a.label);
                 const indexB = order.indexOf(b.label);
                 if (indexA === -1 && indexB === -1) return a.label.localeCompare(b.label);
                 if (indexA === -1) return 1;
                 if (indexB === -1) return -1;
                 return indexA - indexB;
             });

             statsToDisplay.forEach(item => {
                 const p = document.createElement('p');
                 p.innerHTML = `<span class="font-medium">${item.label}:</span> Trung bình ${formatTimeInSeconds(item.average)} (${item.average}s) / ${item.count} câu`;
                 targetElement.appendChild(p);
             });
        }

        // === History Management ===

        /** Gets history from localStorage */
        function getHistory() {
            const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
            try {
                const history = historyJson ? JSON.parse(historyJson) : [];
                return history.map(item => {
                    if (item?.id && item.date && typeof item.date === 'string') {
                         const dateObj = new Date(item.date);
                         if (!isNaN(dateObj.getTime())) {
                             item.questionTimes = Array.isArray(item.questionTimes) ? item.questionTimes : [];
                             return { ...item, date: dateObj };
                         }
                    }
                    return null;
                 }).filter(item => item !== null);
            } catch (e) { console.error("Lỗi đọc lịch sử:", e); showError("Lỗi đọc dữ liệu lịch sử."); return []; }
        }

         /** Saves history array to localStorage */
         function saveHistoryToStorage(historyArray) {
             try {
                  const historyToSave = historyArray.map(item => ({
                       ...item,
                       date: item.date instanceof Date ? item.date.toISOString() : item.date
                   }));
                 localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(historyToSave));
             } catch (e) { console.error("Lỗi lưu lịch sử:", e); showError("Không thể lưu lịch sử."); }
         }

        /** Saves a single exam to history */
        function saveExamToHistory(examData) {
             if (!examData?.id || !(examData.date instanceof Date)) { console.error("Dữ liệu bài thi không hợp lệ:", examData); return; };
            const history = getHistory();
            const existingIndex = history.findIndex(item => item.id === examData.id);
            if (existingIndex === -1) history.push(examData);
            else { console.warn(`Ghi đè bài thi ID ${examData.id}.`); history[existingIndex] = examData; }
            saveHistoryToStorage(history);
        }

        /** Gets a specific exam by ID */
        function getExamFromHistory(examId) {
            const history = getHistory();
            const numericExamId = typeof examId === 'string' ? Number(examId) : examId;
            if (isNaN(numericExamId)) return null;
            return history.find(exam => exam.id === numericExamId) || null;
        }

        /** Updates a question's label in history */
        function updateLabelInHistory(examId, questionNumber, newLabel) {
            const history = getHistory();
            const numericExamId = typeof examId === 'string' ? Number(examId) : examId;
            if (isNaN(numericExamId)) return;
            const examIndex = history.findIndex(exam => exam.id === numericExamId);
            if (examIndex === -1) { console.error(`Không tìm thấy bài thi ID ${numericExamId}.`); return; }
            if (!Array.isArray(history[examIndex].questionTimes)) history[examIndex].questionTimes = [];
            const questionIndex = history[examIndex].questionTimes.findIndex(q => q.questionNumber === questionNumber);
            if (questionIndex === -1) { console.error(`Không tìm thấy câu ${questionNumber} bài ${numericExamId}.`); return; }
            history[examIndex].questionTimes[questionIndex].label = newLabel;
            saveHistoryToStorage(history);
        }

        /** Deletes a specific exam from history */
        function deleteExamFromHistory(examId) {
            const numericExamId = typeof examId === 'string' ? Number(examId) : examId;
            if (isNaN(numericExamId)) return;
            let history = getHistory();
            history = history.filter(exam => exam.id !== numericExamId);
            saveHistoryToStorage(history);
            console.log(`Đã xóa bài thi ID ${numericExamId}.`);
        }

        /** Clears all history with confirmation */
        function clearAllHistory() {
             const history = getHistory();
              if (history.length === 0) { showError("Lịch sử đã trống."); return; }
              if (confirm("⚠️ CẢNH BÁO:\nXóa toàn bộ lịch sử thi?\nHành động này KHÔNG THỂ HOÀN TÁC.")) {
                 localStorage.removeItem(HISTORY_STORAGE_KEY);
                 console.log("Đã xóa toàn bộ lịch sử.");
                 displayHistory();
                 showError("Đã xóa toàn bộ lịch sử.");
             }
        }

         /** Exports history to a JSON file */
         function exportHistory() {
             const history = getHistory();
             if (history.length === 0) { showError("Không có lịch sử để xuất."); return; }
             const historyForExport = history.map(item => ({ ...item, date: item.date.toISOString() }));
             const historyJson = JSON.stringify(historyForExport, null, 2);
             const blob = new Blob([historyJson], { type: 'application/json;charset=utf-8' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.style.display = 'none';
             a.href = url;
              const dateStr = new Date().toISOString().slice(0, 10);
              a.download = `lich_su_thi_thu_${dateStr}.json`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
             URL.revokeObjectURL(url);
             showError("Đã xuất lịch sử thành công.");
         }

        /** Displays the history screen */
        function displayHistory() {
            clearInterval(timerInterval); clearInterval(currentQuestionTimerInterval);
            timerInterval = null; currentQuestionTimerInterval = null;
            isPaused = false; pausedTime = 0; totalPauseDuration = 0;

            hideAllSections();
            historyAreaDiv.classList.remove('hidden');
            chartContainer.classList.add('hidden'); // Ensure chart is hidden initially

            const history = getHistory();
            historyTableBody.innerHTML = '';

            if (history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 dark:text-gray-400 py-4 italic">Chưa có lịch sử thi nào.</td></tr>`;
                viewChartsButton.disabled = true; // Disable chart button if no history
                return;
            }
            viewChartsButton.disabled = false; // Enable chart button

            history.sort((a, b) => b.date.getTime() - a.date.getTime());

            history.forEach(exam => {
                const examSubject = exam.subject || 'N/A';
                const examNumber = exam.examNumber || 'N/A';
                const examDate = formatDate(exam.date);
                const timeTaken = (exam.totalTimeTaken !== undefined && exam.totalTimeTaken !== null) ? formatTime(exam.totalTimeTaken) : 'N/A';

                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                row.innerHTML = `
                    <td class="whitespace-nowrap">${examDate}</td>
                    <td>${examSubject}</td>
                    <td>${examNumber}</td>
                    <td class="whitespace-nowrap">${timeTaken}</td>
                    <td><button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium view-detail-btn" data-id="${exam.id}">Xem</button></td>
                    <td><button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm font-medium delete-history-btn" data-id="${exam.id}">Xóa</button></td>
                `;
                historyTableBody.appendChild(row);
            });
        }

        /** Handles clicks within the history table */
        function handleHistoryTableClick(e) {
            const target = e.target;
            if (target?.classList.contains('view-detail-btn')) {
                const examId = target.getAttribute('data-id');
                if (examId) showHistoryDetail(examId);
            } else if (target?.classList.contains('delete-history-btn')) {
               const examId = target.getAttribute('data-id');
               if (examId) {
                   const examData = getExamFromHistory(examId);
                   const confirmMsg = `Xóa bài thi "${examData?.subject || 'N/A'} - ${examData?.examNumber || 'N/A'}" (${formatDate(examData?.date)})?\n\nKHÔNG THỂ HOÀN TÁC.`;
                   if (confirm(confirmMsg)) {
                       deleteExamFromHistory(examId);
                       displayHistory();
                       showError("Đã xóa bài thi.");
                   }
               }
            }
        }

        /** Shows the history detail modal */
        function showHistoryDetail(examId) {
            const examData = getExamFromHistory(examId);
            if (!examData) { showError("Không tìm thấy dữ liệu chi tiết."); return; }

            modalTitle.textContent = `Chi tiết: ${examData.subject || 'N/A'} - ${examData.examNumber || 'N/A'}`;
            modalSubject.textContent = examData.subject || 'N/A';
            modalExamNumber.textContent = examData.examNumber || 'N/A';
            modalDate.textContent = formatDate(examData.date);
            modalTotalTimeTaken.textContent = formatTime(examData.totalTimeTaken);
            modalTotalTimeSet.textContent = formatTime(examData.totalTimeSet);
            modalTotalQuestionsSet.textContent = examData.totalQuestionsSet || 'N/A';

            const targetTimePerQuestion = (examData.totalQuestionsSet > 0 && examData.totalTimeSet >= 0) ? Math.round(examData.totalTimeSet / examData.totalQuestionsSet) : 0;
            modalTargetTimePerQuestion.textContent = `${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion}s)`;

            const totalCompletedQuestions = examData.questionTimes?.length || 0;
            const averageTimePerQuestion = totalCompletedQuestions > 0 ? Math.round(examData.totalTimeTaken / totalCompletedQuestions) : 0;
            modalAverageTimePerQuestion.textContent = `${formatTimeInSeconds(averageTimePerQuestion)} (${averageTimePerQuestion}s)`;

            modalStatsTableBody.innerHTML = '';
            if (totalCompletedQuestions === 0) {
                modalStatsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3 italic">Không có dữ liệu câu hỏi.</td></tr>';
            } else {
                 const sortedQuestions = [...examData.questionTimes].sort((a, b) => (a.questionNumber || 0) - (b.questionNumber || 0));
                 sortedQuestions.forEach((qTimeData) => {
                    const questionNumber = qTimeData.questionNumber || 'N/A';
                    const timeTaken = qTimeData.time ?? 0;
                    const label = qTimeData.label || 'Chưa gán';
                    const isFlagged = qTimeData.flagged || false; // Check flag

                    const deviation = timeTaken - targetTimePerQuestion;
                    const deviationText = targetTimePerQuestion > 0 ? (deviation >= 0 ? `+${formatTimeInSeconds(deviation)}` : `-${formatTimeInSeconds(Math.abs(deviation))}`) : 'N/A';
                    const deviationTooltip = targetTimePerQuestion > 0 ? `Mục tiêu: ${formatTimeInSeconds(targetTimePerQuestion)} (${targetTimePerQuestion}s)` : '';

                    const row = document.createElement('tr');
                     row.dataset.examId = examData.id;
                     row.dataset.questionNumber = questionNumber;

                    const flagHtml = isFlagged ? '<span class="flag-indicator" title="Đã đánh dấu">★</span>' : '';

                     row.innerHTML = `
                         <td>Câu ${questionNumber}${flagHtml}</td>
                         <td>${formatTimeInSeconds(timeTaken)} (${timeTaken} giây)</td>
                         <td title="${deviationTooltip}">${deviationText}</td>
                         <td>
                             <select class="label-select-modal" aria-label="Chọn nhãn cho câu ${questionNumber} trong modal">
                                 ${LABEL_OPTIONS.map(opt => `<option value="${opt}" ${label === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                             </select>
                         </td>
                     `;
                     modalStatsTableBody.appendChild(row);
                 });
            }
             displayStatsByLabel(examData, modalStatsByLabelArea);
            historyDetailModal.style.display = "block";
            document.body.style.overflow = 'hidden';
        }

        /** Closes the history detail modal */
        function closeModal() {
            historyDetailModal.style.display = "none";
            document.body.style.overflow = '';
        }

        // === Charting Functions (NEW) ===

        /** Displays history charts */
        function displayHistoryCharts() {
             const history = getHistory();
             if (history.length === 0) {
                 showError("Không có dữ liệu lịch sử để vẽ biểu đồ.");
                 return;
             }

             chartContainer.classList.remove('hidden'); // Show the chart section

             // --- Example Chart: Average Time per Subject ---
             const subjectStats = {}; // { subject: { totalTime: 0, totalQuestions: 0, count: 0 } }

             history.forEach(exam => {
                 const subject = exam.subject || 'Không xác định';
                 if (!subjectStats[subject]) {
                     subjectStats[subject] = { totalTime: 0, totalQuestions: 0, count: 0 };
                 }
                 // Calculate average time per question for *this specific exam*
                 const completedQuestions = exam.questionTimes?.length || 0;
                 if (completedQuestions > 0) {
                     const avgTimeThisExam = exam.totalTimeTaken / completedQuestions;
                     subjectStats[subject].totalTime += avgTimeThisExam; // Sum of averages (might be better ways to aggregate)
                     subjectStats[subject].count++;
                 }
                 // Or track total time / total questions across all exams for a subject
                 // subjectStats[subject].totalTime += exam.totalTimeTaken;
                 // subjectStats[subject].totalQuestions += (exam.questionTimes?.length || 0);
                 // subjectStats[subject].count++; // Count exams
             });

             const chartLabels = Object.keys(subjectStats);
             const chartData = chartLabels.map(subject => {
                 const stats = subjectStats[subject];
                 // Calculate overall average for the subject based on summed averages
                 return stats.count > 0 ? Math.round(stats.totalTime / stats.count) : 0;
                 // Or based on total time / total questions
                 // return stats.totalQuestions > 0 ? Math.round(stats.totalTime / stats.totalQuestions) : 0;
             });

             // Get theme-appropriate colors
             const isDark = bodyElement.classList.contains('dark');
             const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
             const labelColor = isDark ? '#e5e7eb' : '#4b5563'; // gray-200 / gray-600
             const barBgColor = isDark ? 'rgba(96, 165, 250, 0.7)' : 'rgba(59, 130, 246, 0.7)'; // blue-400 / blue-500 with alpha
             const barBorderColor = isDark ? '#60a5fa' : '#3b82f6'; // blue-400 / blue-500

             // Destroy previous chart instance if it exists
             if (historyChartInstance) {
                 historyChartInstance.destroy();
             }

             // Create new chart
             const ctx = historyChartCanvas.getContext('2d');
             historyChartInstance = new Chart(ctx, {
                 type: 'bar', // Or 'line', 'pie', etc.
                 data: {
                     labels: chartLabels,
                     datasets: [{
                         label: 'Thời gian trung bình/câu (giây)',
                         data: chartData,
                         backgroundColor: barBgColor,
                         borderColor: barBorderColor,
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false, // Allow chart to fill container height
                     scales: {
                         y: {
                             beginAtZero: true,
                             title: { display: true, text: 'Thời gian (giây)', color: labelColor },
                             ticks: { color: labelColor },
                             grid: { color: gridColor }
                         },
                         x: {
                             title: { display: true, text: 'Môn thi', color: labelColor },
                             ticks: { color: labelColor },
                             grid: { color: gridColor }
                         }
                     },
                     plugins: {
                         legend: { display: false }, // Hide legend for single dataset
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) label += ': ';
                                     if (context.parsed.y !== null) {
                                         label += `${context.parsed.y} giây`;
                                     }
                                     return label;
                                 }
                             }
                         }
                     }
                 }
             });
        }

         /** Hides the chart container */
         function hideCharts() {
             chartContainer.classList.add('hidden');
             if (historyChartInstance) {
                 historyChartInstance.destroy(); // Destroy chart when hiding
                 historyChartInstance = null;
             }
         }


        // === Keyboard Shortcuts (NEW) ===

        /** Handles key presses for shortcuts */
        function handleKeyPress(event) {
            // Ignore if typing in inputs/selects or if modal is open
            const activeElement = document.activeElement;
            const isInputFocused = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT' || activeElement.tagName === 'TEXTAREA');
            const isModalOpen = historyDetailModal.style.display === 'block';

            if (isInputFocused || isModalOpen) return;

            // Only apply shortcuts when exam is active and not paused
            if (examStartTime > 0 && !isPaused) {
                switch (event.key) {
                    case ' ': // Spacebar
                    case 'Enter':
                        event.preventDefault(); // Prevent default space scroll / enter submit
                        nextQuestionButton.click(); // Simulate click
                        break;
                    case 'p':
                    case 'P':
                        event.preventDefault();
                        pauseResumeButton.click();
                        break;
                    case 'Escape': // Esc key
                        event.preventDefault();
                        // Directly call confirm function to ensure confirmation dialog
                        confirmAndEndExam();
                        break;
                    case 'f': // NEW: Flag shortcut
                    case 'F':
                         event.preventDefault();
                         flagQuestionButton.click();
                         break;
                }
            } else if (examStartTime > 0 && isPaused && (event.key === 'p' || event.key === 'P')) {
                 // Allow resuming with 'P' even when paused
                 event.preventDefault();
                 pauseResumeButton.click();
            }
        }


        // === Event Listeners ===

        // Settings Screen
        startButton.addEventListener('click', startExam);
        viewHistoryButton.addEventListener('click', displayHistory);
        darkModeToggle.addEventListener('change', toggleDarkMode); // NEW
        soundToggle.addEventListener('change', toggleSound); // NEW

        // Exam Screen
        nextQuestionButton.addEventListener('click', nextQuestion);
        endExamButton.addEventListener('click', confirmAndEndExam);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        flagQuestionButton.addEventListener('click', toggleFlagQuestion); // NEW

        // Results Screen
        restartButton.addEventListener('click', showSettings);
        viewHistoryFromResultsButton.addEventListener('click', displayHistory);

        // History Screen
        backToSettingsButton.addEventListener('click', showSettings);
        exportHistoryButton.addEventListener('click', exportHistory);
        clearHistoryButton.addEventListener('click', clearAllHistory);
        viewChartsButton.addEventListener('click', displayHistoryCharts); // NEW
        closeChartButton.addEventListener('click', hideCharts); // NEW
        historyTableBody.addEventListener('click', handleHistoryTableClick); // Delegation

        // Modal
        modalStatsTableBody.addEventListener('change', (e) => { // Delegation for modal selects
             if (e.target?.classList.contains('label-select-modal')) {
                 const select = e.target;
                 const row = select.closest('tr');
                 if (!row) return;
                 const newLabel = select.value;
                 const examId = row.dataset.examId;
                 const qNumber = parseInt(row.dataset.questionNumber);
                 if (examId && !isNaN(qNumber)) {
                     updateLabelInHistory(examId, qNumber, newLabel);
                     const updatedExamData = getExamFromHistory(examId);
                     if (updatedExamData) displayStatsByLabel(updatedExamData, modalStatsByLabelArea);
                 }
             }
         });
        // Close modal handled by inline onclick and window click listener below

        // Global Listeners
        window.onclick = function(event) { // Close modal on overlay click
            if (event.target == historyDetailModal) closeModal();
        }
        document.addEventListener('keydown', handleKeyPress); // NEW: Keyboard shortcuts

        // === Initialization ===
        document.addEventListener('DOMContentLoaded', () => {
            loadAppSettings(); // Load settings first
            showSettings();    // Then show the initial screen
        });

    </script>
</body>
</html>
