<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng H·∫πn gi·ªù Thi th·ª≠ Th√¥ng minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        button { transition: background-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s ease; border-radius: 0.375rem; }
        button:not(:disabled):hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        button:not(:disabled):active { transform: scale(0.98); box-shadow: none; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .stats-table th, .stats-table td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: left; vertical-align: middle; }
        .stats-table th { background-color: #f1f5f9; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; color: #475569; }
        .stats-table td { font-size: 0.875rem; color: #4a5568; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #ffffff; margin: 5% auto; padding: 25px; border: 1px solid #d1d5db; width: 90%; max-width: 700px; border-radius: 8px; position: relative; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); animation: slideInFromTop 0.3s ease-out; }
        @keyframes slideInFromTop { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-button { color: #9ca3af; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s ease; }
        .close-button:hover, .close-button:focus { color: #4b5563; text-decoration: none; }
        .table-container { overflow-x: auto; max-height: 400px; border: 1px solid #e5e7eb; border-radius: 0.375rem; }
        .table-filter-container { margin-top: 15px; margin-bottom: 8px; display: flex; justify-content: flex-end; align-items: center; flex-wrap: wrap; gap: 8px; }
        .table-filter-container label { font-size: 0.875rem; color: #4b5563; white-space: nowrap; flex-shrink: 0; }
        .table-filter-select { padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.875rem; background-color: white; min-width: 150px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); flex-grow: 1; }
        .table-filter-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .results-stats-table td { vertical-align: middle; }
        .label-select, .label-select-modal, #examLabelSelect, #subjectSelect { padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.875rem; cursor: pointer; min-width: 110px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; width: 100%; }
        #examLabelSelect { width: 100%; max-width: xs; margin-left: auto; margin-right: auto; display: block; }
        #examLabelSelect, #subjectSelect { background-color: white; }
        .label-select:focus, .label-select-modal:focus, #examLabelSelect:focus, #subjectSelect:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .too-slow { background-color: #fef3c7 !important; }
        .too-fast { background-color: #d1fae5 !important; }
        .too-slow select, .too-fast select { border-color: #fcd34d; }
        #progressBarContainer { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 10px; overflow: hidden; margin-top: 1rem; margin-bottom: 1rem; }
        #progressBar { background-color: #2563eb; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="text"]#newLabelInput:focus, input[type="text"]#newSubjectInput:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        #currentQuestionTimerDisplay { font-size: 1.125rem; color: #4b5563; margin-top: 0.25rem; }
        .management-list ul { list-style: none; padding: 0; }
        .management-list li { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e5e7eb; }
        .management-list li:last-child { border-bottom: none; }
        .management-list .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.875rem; padding: 2px 5px; margin-left: 8px; flex-shrink: 0; }
        .management-list .delete-btn:hover { color: #dc2626; text-decoration: underline; }
        .management-list .item-text { flex: 1; margin-right: 8px; word-break: break-word; }
        .color-square { display: inline-block; width: 0.75rem; height: 0.75rem; margin-right: 0.5rem; border-radius: 0.125rem; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .wake-lock-toggle { appearance: none; width: 36px; height: 20px; background-color: #ccc; border-radius: 10px; position: relative; cursor: pointer; transition: background-color 0.2s ease-in-out; vertical-align: middle; flex-shrink: 0; }
        .wake-lock-toggle::before { content: ''; position: absolute; width: 16px; height: 16px; background-color: white; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s ease-in-out; }
        .wake-lock-toggle:checked { background-color: #2563eb; }
        .wake-lock-toggle:checked::before { transform: translateX(16px); }
        #wakeLockStatus { font-style: italic; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        #targetExamCountdownDisplay { min-height: 1.75rem; /* approx h-7, prevent layout shift */ transition: background-color 0.3s ease, color 0.3s ease; /* Smooth color transition */ }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-3xl">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-blue-600 mb-2">·ª®ng d·ª•ng H·∫πn gi·ªù Thi th·ª≠ Th√¥ng minh</h1>
        <div class="text-center mb-4">
             <div id="targetExamCountdownDisplay" class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-lg font-semibold text-sm shadow-sm min-h-[1.75rem]">
                 </div>
        </div>

        <div id="mainContent">
            <div id="settings" class="space-y-4">
                <div> <div class="flex justify-between items-center mb-1"> <label for="subjectSelect" class="block text-sm font-medium text-gray-700">M√¥n thi:</label> <button id="manageSubjectsButton" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium py-1">Qu·∫£n l√Ω</button> </div> <select id="subjectSelect" class="w-full"> </select> </div> <div> <label for="examNumberInput" class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªÅ s·ªë / T√™n b√†i thi:</label> <input type="text" id="examNumberInput" placeholder="V√≠ d·ª•: ƒê·ªÅ 1, Gi·ªØa k·ª≥" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"> </div> <div class="flex flex-col sm:flex-row gap-4"> <div class="flex-1"> <label for="totalTimeInput" class="block text-sm font-medium text-gray-700 mb-1">T·ªïng th·ªùi gian l√†m b√†i (ph√∫t):</label> <input type="number" id="totalTimeInput" value="60" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"> </div> <div class="flex-1"> <label for="totalQuestionsInput" class="block text-sm font-medium text-gray-700 mb-1">T·ªïng s·ªë c√¢u h·ªèi:</label> <input type="number" id="totalQuestionsInput" value="50" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"> </div> </div>
                <button id="startButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4"> B·∫Øt ƒë·∫ßu l√†m b√†i </button>
                <div class="flex flex-col sm:flex-row gap-3 mt-3"> <button id="viewHistoryButton" class="w-full sm:w-auto flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Xem L·ªãch s·ª≠ Thi </button> <button id="manageLabelsButton" class="w-full sm:w-auto flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4"> Qu·∫£n l√Ω Nh√£n </button> </div>

                 <div class="border-t border-gray-200 pt-4 mt-4">
                    <button id="setTargetExamButton" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium w-full text-left py-1 flex justify-between items-center">
                        <span>C√†i ƒë·∫∑t K·ª≥ thi M·ª•c ti√™u</span>
                        <svg id="targetExamToggleIcon" class="w-4 h-4 transition-transform transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="targetExamSettings" class="hidden mt-2 space-y-3 bg-gray-50 p-3 rounded-md border border-gray-200">
                        <div> <label for="targetExamNameInput" class="block text-xs font-medium text-gray-600 mb-1">T√™n K·ª≥ thi:</label> <input type="text" id="targetExamNameInput" placeholder="VD: Thi THPT Qu·ªëc Gia, Thi v√†o l·ªõp 10" class="w-full text-sm px-2 py-1 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500"> </div>
                        <div> <label for="targetExamDateInput" class="block text-xs font-medium text-gray-600 mb-1">Ng√†y thi:</label> <input type="date" id="targetExamDateInput" class="w-full text-sm px-2 py-1 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500"> </div>
                        <div class="flex gap-2 justify-end"> <button id="saveTargetExamButton" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1 px-3 rounded-md">L∆∞u</button> <button id="clearTargetExamButton" type="button" class="text-sm bg-gray-400 hover:bg-gray-500 text-white font-semibold py-1 px-3 rounded-md">X√≥a</button> </div>
                    </div>
                 </div>
            </div>

            <div id="examArea" class="hidden space-y-4">
                 <div class="text-center mb-4 p-3 bg-blue-50 rounded-md border border-blue-200"> <p class="text-sm font-medium text-blue-800">M√¥n: <span id="currentSubjectDisplay" class="font-semibold"></span> - ƒê·ªÅ: <span id="currentExamNumberDisplay" class="font-semibold"></span></p> </div> <div class="text-center"> <p class="text-lg font-medium text-gray-700 mb-1">Th·ªùi gian c√≤n l·∫°i:</p> <div class="inline-block bg-white rounded-lg shadow px-6 py-3 my-2"> <div id="timerDisplay" class="text-5xl md:text-6xl font-bold text-red-500 tabular-nums">00:00:00</div> </div> <p id="currentQuestionTimerDisplay" class="text-lg text-gray-600 mt-1">Th·ªùi gian c√¢u n√†y: <span id="currentQuestionTime">00:00</span></p> <p class="text-sm text-gray-500 mt-2">ƒêang l√†m c√¢u: <span id="currentQuestionNumber" class="font-semibold">1</span> / <span id="totalQuestionsDisplay">?</span></p> <div id="progressBarContainer"> <div id="progressBar" style="width: 0%"></div> </div> </div> <div class="mt-2"> <label for="examLabelSelect" class="block text-sm font-medium text-gray-700 mb-1 text-center">G√°n nh√£n cho c√¢u <span id="currentQuestionNumberLabel">1</span> (t√πy ch·ªçn):</label> <select id="examLabelSelect" > </select> </div> <div class="space-y-3 mt-4"> <button id="nextQuestionButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 text-lg">Ho√†n th√†nh c√¢u / B√†i ti·∫øp theo</button> <div class="flex gap-3"> <button id="pauseResumeButton" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4">T·∫°m d·ª´ng</button> <button id="endExamButton" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4">K·∫øt th√∫c</button> </div> </div> <div id="wakeLockControl" class="mt-4 text-center text-sm hidden border-t pt-3 border-gray-200"> <label for="keepScreenOnToggle" class="mr-2 text-gray-600 cursor-pointer">Gi·ªØ m√†n h√¨nh s√°ng:</label> <input type="checkbox" id="keepScreenOnToggle" class="wake-lock-toggle"> <span id="wakeLockStatus" class="text-xs text-gray-500 ml-1"></span> </div>
            </div>

             <div id="resultsArea" class="hidden mt-6"> <h2 class="text-xl font-semibold text-center text-blue-600 mb-4">K·∫øt qu·∫£ l√†m b√†i</h2> <div class="text-center mb-4 p-3 bg-green-50 rounded-md border border-green-200"> <p class="text-sm font-medium text-green-800">M√¥n: <span id="resultSubjectDisplay" class="font-semibold"></span> - ƒê·ªÅ: <span id="resultExamNumberDisplay" class="font-semibold"></span></p> <p class="text-sm text-gray-600 mt-1">Ng√†y thi: <span id="resultDateDisplay" class="font-medium"></span></p> </div> <div class="text-center mb-4 space-y-1 text-sm"> <p>T·ªïng th·ªùi gian l√†m b√†i: <span id="totalTimeTaken" class="font-medium"></span></p> <p class="text-gray-600">(Th·ªùi gian c√†i ƒë·∫∑t: <span id="totalTimeSetDisplay"></span>, T·ªïng s·ªë c√¢u c√†i ƒë·∫∑t: <span id="totalQuestionsSetDisplay"></span>)</p> <p class="text-gray-800 font-medium">Th·ªùi gian trung b√¨nh/c√¢u (ƒë√£ l√†m): <span id="averageTimePerQuestionDisplay"></span></p> <p class="text-blue-700 font-medium">Th·ªùi gian m·ª•c ti√™u/c√¢u (theo c√†i ƒë·∫∑t): <span id="targetTimePerQuestionDisplay"></span></p> </div> <h3 class="text-lg font-semibold text-gray-700 mb-2">Chi ti·∫øt th·ªùi gian t·ª´ng c√¢u</h3> <div class="table-filter-container"> <label for="resultsFilterLabelSelect">L·ªçc theo nh√£n:</label> <select id="resultsFilterLabelSelect" class="table-filter-select"> </select> </div> <div class="table-container"> <table class="stats-table results-stats-table w-full border-collapse"> <thead> <tr> <th>C√¢u s·ªë</th> <th>Th·ªùi gian ho√†n th√†nh</th> <th>So v·ªõi m·ª•c ti√™u</th> <th>Nh√£n</th> </tr> </thead> <tbody id="statsTableBody"> </tbody> </table> </div> <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Th·ªëng k√™ theo nh√£n</h3> <div id="statsByLabelArea" class="space-y-1 text-sm text-gray-700 p-3 bg-gray-50 rounded-md border border-gray-200"> </div> <div class="flex flex-col sm:flex-row gap-3 mt-6"> <button id="restartButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4"> L√†m b√†i thi kh√°c </button> <button id="viewHistoryFromResultsButton" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Xem L·ªãch s·ª≠ Thi </button> </div> </div>
             <div id="historyArea" class="hidden mt-6"> <h2 class="text-xl font-semibold text-center text-blue-600 mb-4">L·ªãch s·ª≠ Thi</h2> <div class="table-filter-container mb-4 justify-end"> <label for="historyFilterSubjectSelect">L·ªçc theo m√¥n thi:</label> <select id="historyFilterSubjectSelect" class="table-filter-select"> </select> </div> <div class="table-container"> <table id="historyTable" class="stats-table w-full border-collapse"> <thead> <tr> <th>Ng√†y thi</th> <th>M√¥n thi</th> <th>ƒê·ªÅ s·ªë</th> <th>T·ªïng th·ªùi gian</th> <th>Chi ti·∫øt</th> <th>H√†nh ƒë·ªông</th> </tr> </thead> <tbody id="historyTableBody"> </tbody> </table> </div> <div class="mt-4 space-y-3"> <button id="exportHistoryButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4"> Xu·∫•t L·ªãch s·ª≠ (JSON) </button> <button id="clearHistoryButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4"> X√≥a To√†n B·ªô L·ªãch S·ª≠ (KH√îNG TH·ªÇ HO√ÄN T√ÅC) </button> <button id="backToSettingsButton" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Quay l·∫°i C√†i ƒë·∫∑t </button> </div> </div>
             <div id="labelManagementArea" class="hidden mt-6 management-list"> <h2 class="text-xl font-semibold text-center text-indigo-600 mb-4">Qu·∫£n l√Ω Nh√£n T√πy ch·ªânh</h2> <div class="mb-4"> <label for="newLabelInput" class="block text-sm font-medium text-gray-700 mb-1">Th√™m nh√£n m·ªõi:</label> <div class="flex gap-2"> <input type="text" id="newLabelInput" placeholder="Nh·∫≠p t√™n nh√£n..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"> <button id="addLabelButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4"> Th√™m </button> </div> </div> <h3 class="text-lg font-semibold text-gray-700 mb-2">C√°c nh√£n t√πy ch·ªânh hi·ªán c√≥:</h3> <div class="bg-gray-50 p-3 rounded-md border border-gray-200 max-h-60 overflow-y-auto"> <ul id="customLabelsList"> <li class="italic text-gray-500 text-center" id="noCustomLabelsMessage">Ch∆∞a c√≥ nh√£n t√πy ch·ªânh n√†o.</li> </ul> </div> <button id="backToSettingsFromLabelsButton" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Quay l·∫°i C√†i ƒë·∫∑t </button> </div> <div id="subjectManagementArea" class="hidden mt-6 management-list"> <h2 class="text-xl font-semibold text-center text-teal-600 mb-4">Qu·∫£n l√Ω M√¥n thi</h2> <div class="mb-4"> <label for="newSubjectInput" class="block text-sm font-medium text-gray-700 mb-1">Th√™m m√¥n thi m·ªõi:</label> <div class="flex gap-2"> <input type="text" id="newSubjectInput" placeholder="Nh·∫≠p t√™n m√¥n thi..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"> <button id="addSubjectButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4"> Th√™m </button> </div> </div> <h3 class="text-lg font-semibold text-gray-700 mb-2">C√°c m√¥n thi ƒë√£ t·∫°o:</h3> <div class="bg-gray-50 p-3 rounded-md border border-gray-200 max-h-60 overflow-y-auto"> <ul id="subjectsList"> <li class="italic text-gray-500 text-center" id="noSubjectsMessage">Ch∆∞a c√≥ m√¥n thi n√†o ƒë∆∞·ª£c t·∫°o.</li> </ul> </div> <button id="backToSettingsFromSubjectsButton" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4"> Quay l·∫°i C√†i ƒë·∫∑t </button> </div>
             <div id="historyDetailModal" class="modal"> <div class="modal-content"> <span class="close-button" onclick="closeModal()">&times;</span> <h3 class="text-lg font-semibold text-blue-600 mb-3" id="modalTitle">Chi ti·∫øt B√†i thi</h3> <div class="mb-3 text-sm space-y-1 border-b pb-3 border-gray-200"> <p><strong>M√¥n:</strong> <span id="modalSubject"></span></p> <p><strong>ƒê·ªÅ:</strong> <span id="modalExamNumber"></span></p> <p><strong>Ng√†y thi:</strong> <span id="modalDate"></span></p> <p><strong>T·ªïng th·ªùi gian l√†m:</strong> <span id="modalTotalTimeTaken"></span></p> <p><strong>Th·ªùi gian c√†i ƒë·∫∑t:</strong> <span id="modalTotalTimeSet"></span></p> <p><strong>T·ªïng s·ªë c√¢u c√†i ƒë·∫∑t:</strong> <span id="modalTotalQuestionsSet"></span></p> <p><strong>Th·ªùi gian m·ª•c ti√™u/c√¢u:</strong> <span id="modalTargetTimePerQuestion"></span></p> <p class="text-gray-800 font-medium"><strong>Th·ªùi gian trung b√¨nh/c√¢u (ƒë√£ l√†m):</strong> <span id="modalAverageTimePerQuestion"></span></p> </div> <h4 class="text-base font-semibold text-gray-700 mb-2 mt-3">Th·ªùi gian t·ª´ng c√¢u:</h4> <div class="table-filter-container"> <label for="modalFilterLabelSelect">L·ªçc theo nh√£n:</label> <select id="modalFilterLabelSelect" class="table-filter-select"> </select> </div> <div class="table-container"> <table class="stats-table w-full border-collapse"> <thead> <tr> <th>C√¢u s·ªë</th> <th>Th·ªùi gian ho√†n th√†nh</th> <th>So v·ªõi m·ª•c ti√™u</th> <th>Nh√£n</th> </tr> </thead> <tbody id="modalStatsTableBody"> </tbody> </table> </div> <h4 class="text-base font-semibold text-gray-700 mt-4 mb-2">Th·ªëng k√™ theo nh√£n:</h4> <div id="modalStatsByLabelArea" class="space-y-1 text-sm text-gray-700 p-3 bg-gray-50 rounded-md border border-gray-200"> </div> </div> </div>

        </div> <div id="errorMessage" class="hidden mt-4 text-center text-red-600 bg-red-100 p-3 rounded-md border border-red-200"></div>
    </div> <script>
        // === DOM Elements ===
        const mainContentDiv=document.getElementById("mainContent"),settingsDiv=document.getElementById("settings"),examAreaDiv=document.getElementById("examArea"),resultsAreaDiv=document.getElementById("resultsArea"),historyAreaDiv=document.getElementById("historyArea"),labelManagementArea=document.getElementById("labelManagementArea"),subjectManagementArea=document.getElementById("subjectManagementArea"),subjectSelect=document.getElementById("subjectSelect"),examNumberInput=document.getElementById("examNumberInput"),totalTimeInput=document.getElementById("totalTimeInput"),totalQuestionsInput=document.getElementById("totalQuestionsInput"),startButton=document.getElementById("startButton"),viewHistoryButton=document.getElementById("viewHistoryButton"),viewHistoryFromResultsButton=document.getElementById("viewHistoryFromResultsButton"),manageLabelsButton=document.getElementById("manageLabelsButton"),manageSubjectsButton=document.getElementById("manageSubjectsButton"),currentSubjectDisplay=document.getElementById("currentSubjectDisplay"),currentExamNumberDisplay=document.getElementById("currentExamNumberDisplay"),timerDisplay=document.getElementById("timerDisplay"),currentQuestionNumberSpan=document.getElementById("currentQuestionNumber"),totalQuestionsDisplay=document.getElementById("totalQuestionsDisplay"),nextQuestionButton=document.getElementById("nextQuestionButton"),endExamButton=document.getElementById("endExamButton"),pauseResumeButton=document.getElementById("pauseResumeButton"),progressBar=document.getElementById("progressBar"),currentQuestionTimeSpan=document.getElementById("currentQuestionTime"),currentQuestionNumberLabel=document.getElementById("currentQuestionNumberLabel"),examLabelSelect=document.getElementById("examLabelSelect"),resultSubjectDisplay=document.getElementById("resultSubjectDisplay"),resultExamNumberDisplay=document.getElementById("resultExamNumberDisplay"),resultDateDisplay=document.getElementById("resultDateDisplay"),totalTimeTakenSpan=document.getElementById("totalTimeTaken"),totalTimeSetDisplay=document.getElementById("totalTimeSetDisplay"),totalQuestionsSetDisplay=document.getElementById("totalQuestionsSetDisplay"),averageTimePerQuestionDisplay=document.getElementById("averageTimePerQuestionDisplay"),targetTimePerQuestionDisplay=document.getElementById("targetTimePerQuestionDisplay"),statsTableBody=document.getElementById("statsTableBody"),statsByLabelArea=document.getElementById("statsByLabelArea"),restartButton=document.getElementById("restartButton"),resultsFilterLabelSelect=document.getElementById("resultsFilterLabelSelect"),historyTableBody=document.getElementById("historyTableBody"),backToSettingsButton=document.getElementById("backToSettingsButton"),exportHistoryButton=document.getElementById("exportHistoryButton"),clearHistoryButton=document.getElementById("clearHistoryButton"),historyDetailModal=document.getElementById("historyDetailModal"),modalTitle=document.getElementById("modalTitle"),modalSubject=document.getElementById("modalSubject"),modalExamNumber=document.getElementById("modalExamNumber"),modalDate=document.getElementById("modalDate"),modalTotalTimeTaken=document.getElementById("modalTotalTimeTaken"),modalTotalTimeSet=document.getElementById("modalTotalTimeSet"),modalTotalQuestionsSet=document.getElementById("modalTotalQuestionsSet"),modalTargetTimePerQuestion=document.getElementById("modalTargetTimePerQuestion"),modalAverageTimePerQuestion=document.getElementById("modalAverageTimePerQuestion"),modalStatsTableBody=document.getElementById("modalStatsTableBody"),modalStatsByLabelArea=document.getElementById("modalStatsByLabelArea"),modalFilterLabelSelect=document.getElementById("modalFilterLabelSelect"),newLabelInput=document.getElementById("newLabelInput"),addLabelButton=document.getElementById("addLabelButton"),customLabelsList=document.getElementById("customLabelsList"),noCustomLabelsMessage=document.getElementById("noCustomLabelsMessage"),backToSettingsFromLabelsButton=document.getElementById("backToSettingsFromLabelsButton"),newSubjectInput=document.getElementById("newSubjectInput"),addSubjectButton=document.getElementById("addSubjectButton"),subjectsList=document.getElementById("subjectsList"),noSubjectsMessage=document.getElementById("noSubjectsMessage"),backToSettingsFromSubjectsButton=document.getElementById("backToSettingsFromSubjectsButton"),errorMessageDiv=document.getElementById("errorMessage"),wakeLockControl=document.getElementById("wakeLockControl"),keepScreenOnToggle=document.getElementById("keepScreenOnToggle"),wakeLockStatus=document.getElementById("wakeLockStatus"),historyFilterSubjectSelect=document.getElementById("historyFilterSubjectSelect"),targetExamCountdownDisplay=document.getElementById("targetExamCountdownDisplay"),setTargetExamButton=document.getElementById("setTargetExamButton"),targetExamSettings=document.getElementById("targetExamSettings"),targetExamNameInput=document.getElementById("targetExamNameInput"),targetExamDateInput=document.getElementById("targetExamDateInput"),saveTargetExamButton=document.getElementById("saveTargetExamButton"),clearTargetExamButton=document.getElementById("clearTargetExamButton"),targetExamToggleIcon=document.getElementById("targetExamToggleIcon");

        // === State Variables ===
        let totalSecondsSet=0,totalQuestionsSet=0,secondsRemaining=0,currentQuestionIndex=1,pausedTime=0,totalPauseDuration=0,currentQuestionSeconds=0,timerInterval=null,questionStartTime=0,examStartTime=0,currentQuestionTimerInterval=null,isPaused=!1,currentExamData=null,isExamRunning=!1,screenWakeLockSentinel=null;const isWakeLockSupported="wakeLock"in navigator;

        // === Constants ===
        const HISTORY_STORAGE_KEY="examTimerHistoryV4",CUSTOM_LABELS_KEY="examTimerCustomLabelsV1",SUBJECTS_KEY="examTimerSubjectsV1",DEFAULT_LABELS=["Ch∆∞a g√°n","D·ªÖ","Trung b√¨nh","Kh√≥","L√Ω thuy·∫øt","B√†i t·∫≠p","Kh√°c"],DEFAULT_LABEL_COLORS={"Ch∆∞a g√°n":{bg:"bg-gray-100",text:"text-gray-800"},D·ªÖ:{bg:"bg-green-100",text:"text-green-800"},"Trung b√¨nh":{bg:"bg-blue-100",text:"text-blue-800"},Kh√≥:{bg:"bg-red-100",text:"text-red-800"},"L√Ω thuy·∫øt":{bg:"bg-yellow-100",text:"text-yellow-800"},"B√†i t·∫≠p":{bg:"bg-purple-100",text:"text-purple-800"},Kh√°c:{bg:"bg-indigo-100",text:"text-indigo-800"}},CUSTOM_LABEL_COLOR_CYCLE=[{bg:"bg-pink-100",text:"text-pink-800"},{bg:"bg-cyan-100",text:"text-cyan-800"},{bg:"bg-orange-100",text:"text-orange-800"},{bg:"bg-lime-100",text:"text-lime-800"},{bg:"bg-teal-100",text:"text-teal-800"},{bg:"bg-fuchsia-100",text:"text-fuchsia-800"},{bg:"bg-sky-100",text:"text-sky-800"},{bg:"bg-rose-100",text:"text-rose-800"}],FALLBACK_COLOR={bg:"bg-gray-100",text:"text-gray-800"},ALL_LABELS_FILTER_VALUE="__ALL__",ALL_SUBJECTS_FILTER_VALUE="__ALL_SUBJECTS__",TARGET_EXAM_DATE_KEY="examTimerTargetDateV1",TARGET_EXAM_NAME_KEY="examTimerTargetNameV1";

        // === Utility Functions ===
        function formatTime(e){isNaN(e)||(e<0&&(e=0));const t=Math.floor(e/3600),o=Math.floor(e%3600/60),n=Math.floor(e%60);return`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function formatTimeMMSS(e){isNaN(e)||(e<0&&(e=0));const t=Math.floor(e/60),o=Math.floor(e%60);return`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}`}function formatTimeInSeconds(e){isNaN(e)||(e<0&&(e=0));const t=Math.floor(e/60),o=Math.floor(e%60);return t>0?`${t}p ${o}s`:`${o}s`}function formatDate(e){if(!e||!(e instanceof Date)||isNaN(e.getTime()))return"N/A";try{return e.toLocaleString("vi-VN",{dateStyle:"short",timeStyle:"short"})}catch(t){return console.error("L·ªói ƒë·ªãnh d·∫°ng ng√†y:",t),"N/A"}}function showError(e){errorMessageDiv.textContent=e,errorMessageDiv.classList.remove("hidden"),errorMessageDiv.timeoutId&&clearTimeout(errorMessageDiv.timeoutId),errorMessageDiv.timeoutId=setTimeout(()=>{errorMessageDiv.classList.add("hidden"),errorMessageDiv.timeoutId=null},5e3)}function hideAllSections(){settingsDiv.classList.add("hidden"),examAreaDiv.classList.add("hidden"),resultsAreaDiv.classList.add("hidden"),historyAreaDiv.classList.add("hidden"),labelManagementArea.classList.add("hidden"),subjectManagementArea.classList.add("hidden")}function showSettings(){clearInterval(timerInterval),clearInterval(currentQuestionTimerInterval),timerInterval=null,currentQuestionTimerInterval=null,isPaused=!1,isExamRunning=!1,pausedTime=0,totalPauseDuration=0,examStartTime=0,questionStartTime=0,currentQuestionIndex=1,currentExamData=null,secondsRemaining=0,currentQuestionSeconds=0,releaseWakeLock(),hideAllSections(),settingsDiv.classList.remove("hidden"),populateSubjectSelect(subjectSelect),updateTargetExamCountdown(),targetExamSettings.classList.add("hidden"),targetExamToggleIcon?.classList.remove("rotate-180"),errorMessageDiv.classList.add("hidden"),progressBar.style.width="0%",currentQuestionTimeSpan&&(currentQuestionTimeSpan.textContent="00:00"),wakeLockControl&&wakeLockControl.classList.add("hidden")}

        // === Target Exam Countdown Functions ===
        function getTargetExam(){const e=localStorage.getItem(TARGET_EXAM_NAME_KEY),t=localStorage.getItem(TARGET_EXAM_DATE_KEY);return e&&t&&/^\d{4}-\d{2}-\d{2}$/.test(t)?{name:e,date:t}:null}function saveTargetExam(e,t){e&&t?(localStorage.setItem(TARGET_EXAM_NAME_KEY,e),localStorage.setItem(TARGET_EXAM_DATE_KEY,t)):(localStorage.removeItem(TARGET_EXAM_NAME_KEY),localStorage.removeItem(TARGET_EXAM_DATE_KEY))}function calculateDaysRemaining(e){if(!e)return null;const t=new Date(e+"T00:00:00"),o=new Date;if(o.setHours(0,0,0,0),isNaN(t.getTime()))return null;return Math.ceil((t.getTime()-o.getTime())/864e5)}
        function updateTargetExamCountdown(){
            const targetExam = getTargetExam();
            const displayElement = targetExamCountdownDisplay; // Cache element
            if (!displayElement) return; // Exit if element not found

            // Define base classes (must match HTML)
            const baseClasses = ['inline-block', 'bg-blue-100', 'text-blue-800', 'px-3', 'py-1', 'rounded-lg', 'font-semibold', 'text-sm', 'shadow-sm', 'min-h-[1.75rem]'];
            // Define urgency classes
            const urgentClasses = ['bg-red-100', 'text-red-700', 'font-bold'];
            const soonClasses = ['bg-orange-100', 'text-orange-600', 'font-bold'];

            if (targetExam) {
                const daysRemaining = calculateDaysRemaining(targetExam.date);
                let countdownText = "";
                const examName = targetExam.name ? targetExam.name : "K·ª≥ thi M·ª•c ti√™u";

                // Reset classes to base first
                displayElement.className = baseClasses.join(' ');

                if (daysRemaining === null) {
                    countdownText = `L·ªói: Ng√†y thi m·ª•c ti√™u kh√¥ng h·ª£p l·ªá`;
                    displayElement.classList.remove('bg-blue-100', 'text-blue-800');
                    displayElement.classList.add('bg-red-100', 'text-red-700'); // Indicate error
                } else if (daysRemaining < 0) {
                    countdownText = `${examName}: ƒê√£ qua.`;
                     // Keep base blue style for past events
                } else if (daysRemaining === 0) {
                    countdownText = `${examName}: H√¥m nay! üéâ`;
                     displayElement.classList.remove('bg-blue-100', 'text-blue-800', 'font-semibold');
                     displayElement.classList.add(...urgentClasses); // Apply urgent style
                } else if (daysRemaining === 1) {
                    countdownText = `${examName}: C√≤n 1 ng√†y!`;
                     displayElement.classList.remove('bg-blue-100', 'text-blue-800', 'font-semibold');
                     displayElement.classList.add(...soonClasses); // Apply soon style
                } else if (daysRemaining <= 7) {
                     countdownText = `${examName}: C√≤n ${daysRemaining} ng√†y.`;
                     displayElement.classList.remove('bg-blue-100', 'text-blue-800', 'font-semibold');
                     displayElement.classList.add(...soonClasses); // Apply soon style
                }
                 else {
                    countdownText = `${examName}: C√≤n ${daysRemaining} ng√†y.`;
                     // Keep base style (blue/semibold)
                }
                displayElement.textContent = countdownText;
                displayElement.style.display = 'inline-block'; // Make sure it's visible
            } else {
                displayElement.textContent = "";
                displayElement.style.display = 'none'; // Hide if no target exam set
            }
        }
        function toggleTargetExamSettings(){const e=targetExamSettings.classList.toggle("hidden");targetExamToggleIcon?.classList.toggle("rotate-180",!e),!e&&(()=>{const e=getTargetExam();targetExamNameInput.value=e?.name||"",targetExamDateInput.value=e?.date||""})()}function handleSaveTargetExam(){const e=targetExamNameInput.value.trim(),t=targetExamDateInput.value;if(!e)return void showError("Vui l√≤ng nh·∫≠p T√™n K·ª≥ thi M·ª•c ti√™u.");if(!t)return void showError("Vui l√≤ng ch·ªçn Ng√†y thi M·ª•c ti√™u.");saveTargetExam(e,t),updateTargetExamCountdown(),targetExamSettings.classList.add("hidden"),targetExamToggleIcon?.classList.remove("rotate-180"),showError("ƒê√£ l∆∞u K·ª≥ thi M·ª•c ti√™u.")}function handleClearTargetExam(){confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng tin K·ª≥ thi M·ª•c ti√™u kh√¥ng?")&&(saveTargetExam(null,null),updateTargetExamCountdown(),targetExamNameInput.value="",targetExamDateInput.value="",targetExamSettings.classList.add("hidden"),targetExamToggleIcon?.classList.remove("rotate-180"),showError("ƒê√£ x√≥a K·ª≥ thi M·ª•c ti√™u."))}

        // === Subject Management ===
        function getSubjects(){const e=localStorage.getItem(SUBJECTS_KEY);try{const t=e?JSON.parse(e):[];return Array.isArray(t)&&t.every(e=>"string"==typeof e)?t.sort((e,t)=>e.localeCompare(t)):[]}catch(t){return console.error("L·ªói ƒë·ªçc m√¥n thi t·ª´ localStorage:",t),[]}}function saveSubjects(e){try{Array.isArray(e)&&e.every(e=>"string"==typeof e)?localStorage.setItem(SUBJECTS_KEY,JSON.stringify(e)):(console.error("Attempted to save invalid subjects array:",e),showError("L·ªói: Kh√¥ng th·ªÉ l∆∞u danh s√°ch m√¥n thi kh√¥ng h·ª£p l·ªá."))}catch(t){console.error("L·ªói l∆∞u m√¥n thi v√†o localStorage:",t),showError("Kh√¥ng th·ªÉ l∆∞u m√¥n thi. B·ªô nh·ªõ tr√¨nh duy·ªát c√≥ th·ªÉ ƒë√£ ƒë·∫ßy.")}}function addSubject(){const e=newSubjectInput.value.trim();if(!e)return void showError("T√™n m√¥n thi kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");const t=getSubjects();if(t.map(e=>e.toLowerCase()).includes(e.toLowerCase()))return void showError(`M√¥n thi "${e}" ƒë√£ t·ªìn t·∫°i.`);t.push(e),saveSubjects(t),populateSubjectsList(),populateSubjectSelect(subjectSelect),newSubjectInput.value="",showError(`ƒê√£ th√™m m√¥n thi "${e}".`)}function deleteSubject(e){let t=getSubjects();const o=t.length;t=t.filter(t=>t!==e),t.length<o?(saveSubjects(t),populateSubjectsList(),populateSubjectSelect(subjectSelect),showError(`ƒê√£ x√≥a m√¥n thi "${e}". (L∆∞u √Ω: L·ªãch s·ª≠ thi c≈© s·∫Ω kh√¥ng b·ªã ·∫£nh h∆∞·ªüng)`)):showError(`Kh√¥ng t√¨m th·∫•y m√¥n thi "${e}" ƒë·ªÉ x√≥a.`)}function populateSubjectsList(){const e=getSubjects();subjectsList.innerHTML="",0===e.length?noSubjectsMessage.style.display="block":(noSubjectsMessage.style.display="none",e.forEach(e=>{const t=document.createElement("li");t.innerHTML=`<span class="item-text">${e}</span><button class="delete-btn delete-subject-btn" data-subject="${e}">X√≥a</button>`,subjectsList.appendChild(t)}))}function showSubjectManagement(){hideAllSections(),subjectManagementArea.classList.remove("hidden"),populateSubjectsList(),newSubjectInput.value=""}function handleSubjectManagementListClick(e){if(e.target&&e.target.classList.contains("delete-subject-btn")){const t=e.target.dataset.subject;t&&confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n thi "${t}" kh√¥ng?`)&&deleteSubject(t)}}function populateSubjectSelect(e){const t=getSubjects(),o=e.value;e.innerHTML='<option value="">-- Ch·ªçn m√¥n thi --</option>',t.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,t===o&&(n.selected=!0),e.appendChild(n)}),e.disabled=0===t.length,0===t.length&&settingsDiv&&!settingsDiv.classList.contains("hidden")&&showError("Ch∆∞a c√≥ m√¥n thi n√†o. Vui l√≤ng v√†o 'Qu·∫£n l√Ω' ƒë·ªÉ th√™m.")}

        // === Label Management & Colors ===
        function getCustomLabels(){const e=localStorage.getItem(CUSTOM_LABELS_KEY);try{const t=e?JSON.parse(e):[];return Array.isArray(t)&&t.every(e=>"string"==typeof e)?t:[]}catch(t){return console.error("L·ªói ƒë·ªçc nh√£n t√πy ch·ªânh t·ª´ localStorage:",t),[]}}function saveCustomLabels(e){try{Array.isArray(e)&&e.every(e=>"string"==typeof e)?localStorage.setItem(CUSTOM_LABELS_KEY,JSON.stringify(e)):(console.error("Attempted to save invalid custom labels array:",e),showError("L·ªói: Kh√¥ng th·ªÉ l∆∞u danh s√°ch nh√£n kh√¥ng h·ª£p l·ªá."))}catch(t){console.error("L·ªói l∆∞u nh√£n t√πy ch·ªânh v√†o localStorage:",t),showError("Kh√¥ng th·ªÉ l∆∞u nh√£n t√πy ch·ªânh. B·ªô nh·ªõ tr√¨nh duy·ªát c√≥ th·ªÉ ƒë√£ ƒë·∫ßy.")}}function getAllLabels(){const e=getCustomLabels();return[...DEFAULT_LABELS,...e.filter(e=>!DEFAULT_LABELS.includes(e))]}function showLabelManagement(){hideAllSections(),labelManagementArea.classList.remove("hidden"),populateCustomLabelsList(),newLabelInput.value=""}function populateCustomLabelsList(){const e=getCustomLabels();customLabelsList.innerHTML="",0===e.length?noCustomLabelsMessage.style.display="block":(noCustomLabelsMessage.style.display="none",e.forEach(e=>{const t=document.createElement("li");t.innerHTML=`<span class="item-text">${e}</span><button class="delete-btn delete-label-btn" data-label="${e}">X√≥a</button>`,customLabelsList.appendChild(t)}))}function addCustomLabel(){const e=newLabelInput.value.trim();if(!e)return void showError("T√™n nh√£n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");const t=getCustomLabels(),o=getAllLabels();if(o.map(e=>e.toLowerCase()).includes(e.toLowerCase()))return void showError(`Nh√£n "${e}" ƒë√£ t·ªìn t·∫°i.`);t.push(e),saveCustomLabels(t),populateCustomLabelsList(),newLabelInput.value="",showError(`ƒê√£ th√™m nh√£n "${e}".`)}function deleteCustomLabel(e){let t=getCustomLabels();const o=t.length;t=t.filter(t=>t!==e),t.length<o?(saveCustomLabels(t),populateCustomLabelsList(),showError(`ƒê√£ x√≥a nh√£n "${e}".`)):showError(`Kh√¥ng t√¨m th·∫•y nh√£n "${e}" ƒë·ªÉ x√≥a.`)}function getLabelStyleClasses(e){if(DEFAULT_LABEL_COLORS[e])return DEFAULT_LABEL_COLORS[e];const t=getCustomLabels(),o=t.indexOf(e);return o!==-1&&CUSTOM_LABEL_COLOR_CYCLE.length>0?CUSTOM_LABEL_COLOR_CYCLE[o%CUSTOM_LABEL_COLOR_CYCLE.length]:FALLBACK_COLOR}function populateLabelDropdown(e,t="Ch∆∞a g√°n"){const o=getAllLabels();e.innerHTML="",o.forEach(o=>{const n=document.createElement("option");n.value=o,n.textContent=o,o===t&&(n.selected=!0),e.appendChild(n)});const n=getLabelStyleClasses(t);"examLabelSelect"===e.id&&(e.className=`w-full max-w-xs mx-auto block ${n.bg} ${n.text}`,e.removeEventListener("change",handleExamLabelChange),e.addEventListener("change",handleExamLabelChange))}function handleExamLabelChange(e){const t=e.target,o=t.value,n=getLabelStyleClasses(o);t.className=`w-full max-w-xs mx-auto block ${n.bg} ${n.text}`}

        // === Wake Lock ===
        async function requestWakeLock(){if(!isWakeLockSupported||!keepScreenOnToggle.checked||screenWakeLockSentinel)return void updateWakeLockStatus();try{screenWakeLockSentinel=await navigator.wakeLock.request("screen"),screenWakeLockSentinel.addEventListener("release",()=>{null!==screenWakeLockSentinel&&(screenWakeLockSentinel=null,updateWakeLockStatus())}),updateWakeLockStatus()}catch(e){console.error(`Kh√¥ng th·ªÉ k√≠ch ho·∫°t Wake Lock: ${e.name}, ${e.message}`),screenWakeLockSentinel=null,keepScreenOnToggle.checked=!1,updateWakeLockStatus(!0)}}async function releaseWakeLock(){if(!isWakeLockSupported||!screenWakeLockSentinel)return void updateWakeLockStatus();try{await screenWakeLockSentinel.release()}catch(e){console.error(`Kh√¥ng th·ªÉ gi·∫£i ph√≥ng Wake Lock: ${e.name}, ${e.message}`)}finally{screenWakeLockSentinel=null,updateWakeLockStatus()}}function updateWakeLockStatus(e=!1){isWakeLockSupported&&wakeLockStatus&&(e?(wakeLockStatus.textContent="(L·ªói)",wakeLockStatus.classList.add("text-red-500")):screenWakeLockSentinel?(wakeLockStatus.textContent="(ƒêang b·∫≠t)",wakeLockStatus.classList.remove("text-red-500")):(wakeLockStatus.textContent="(ƒêang t·∫Øt)",wakeLockStatus.classList.remove("text-red-500")))}async function handleVisibilityChange(){!isWakeLockSupported||!isExamRunning||isPaused||("visible"===document.visibilityState&&keepScreenOnToggle.checked?await requestWakeLock():console.log("Tab hidden or wake lock toggle off, sentinel release handled by event."))}

        // === Core Exam Logic ===
        function updateTimer(){if(isPaused||!examStartTime)return;const e=Date.now(),t=Math.floor((e-examStartTime-totalPauseDuration)/1e3);secondsRemaining=totalSecondsSet-t,secondsRemaining<0&&(secondsRemaining=0),timerDisplay.textContent=formatTime(secondsRemaining),totalSecondsSet>0?progressBar.style.width=`${Math.max(0,Math.min(100,t/totalSecondsSet*100))}%`:progressBar.style.width="0%",secondsRemaining<=0?(timerDisplay.textContent=formatTime(0),progressBar.style.width="100%",showError("H·∫øt gi·ªù l√†m b√†i!"),endExam(),timerDisplay.classList.remove("text-red-500","text-orange-500"),timerDisplay.classList.add("text-gray-500")):secondsRemaining<=600?(timerDisplay.classList.remove("text-red-500","text-gray-500"),timerDisplay.classList.add("text-orange-500")):(timerDisplay.classList.remove("text-orange-500","text-gray-500"),timerDisplay.classList.add("text-red-500"))}function updateCurrentQuestionTimer(){isPaused||!examStartTime||(currentQuestionSeconds++,currentQuestionTimeSpan.textContent=formatTimeMMSS(currentQuestionSeconds))}async function startExam(){const e=subjectSelect.value,t=examNumberInput.value.trim(),o=parseInt(totalTimeInput.value),n=parseInt(totalQuestionsInput.value);if(!e)return void showError("Vui l√≤ng ch·ªçn M√¥n thi.");if(!t)return void showError("Vui l√≤ng nh·∫≠p ƒê·ªÅ s·ªë / T√™n b√†i thi.");if(isNaN(o)||o<=0)return void showError("Vui l√≤ng nh·∫≠p t·ªïng th·ªùi gian h·ª£p l·ªá (l·ªõn h∆°n 0 ph√∫t).");if(isNaN(n)||n<=0)return void showError("Vui l√≤ng nh·∫≠p t·ªïng s·ªë c√¢u h·ªèi h·ª£p l·ªá (l·ªõn h∆°n 0 c√¢u).");totalSecondsSet=60*o,totalQuestionsSet=n,secondsRemaining=totalSecondsSet,currentQuestionIndex=1,isPaused=!1,isExamRunning=!0,pausedTime=0,totalPauseDuration=0,currentQuestionSeconds=0,errorMessageDiv.classList.add("hidden"),progressBar.style.width="0%",currentExamData={id:Date.now(),subject:e,examNumber:t,date:new Date,totalTimeSet:totalSecondsSet,totalQuestionsSet:totalQuestionsSet,totalTimeTaken:0,questionTimes:[]},hideAllSections(),examAreaDiv.classList.remove("hidden"),isWakeLockSupported&&wakeLockControl.classList.remove("hidden"),updateWakeLockStatus(),currentSubjectDisplay.textContent=e,currentExamNumberDisplay.textContent=t,timerDisplay.textContent=formatTime(totalSecondsSet),timerDisplay.classList.remove("text-orange-500","text-gray-500"),timerDisplay.classList.add("text-red-500"),currentQuestionNumberSpan.textContent=currentQuestionIndex,totalQuestionsDisplay.textContent=totalQuestionsSet,currentQuestionTimeSpan.textContent="00:00",currentQuestionNumberLabel.textContent=currentQuestionIndex,populateLabelDropdown(examLabelSelect,"Ch∆∞a g√°n"),n<=0?(nextQuestionButton.disabled=!0,endExamButton.disabled=!0,pauseResumeButton.disabled=!0,examLabelSelect.disabled=!0,keepScreenOnToggle.disabled=!0):(nextQuestionButton.disabled=!1,endExamButton.disabled=!1,pauseResumeButton.disabled=!1,pauseResumeButton.textContent="T·∫°m d·ª´ng",pauseResumeButton.classList.remove("bg-green-500","hover:bg-green-600"),pauseResumeButton.classList.add("bg-yellow-500","hover:bg-yellow-600"),examLabelSelect.disabled=!1,keepScreenOnToggle.disabled=!1),1===n?nextQuestionButton.textContent="Ho√†n th√†nh c√¢u cu·ªëi":nextQuestionButton.textContent="Ho√†n th√†nh c√¢u / B√†i ti·∫øp theo";const s=Date.now();examStartTime=s,questionStartTime=s,timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(updateTimer,1e3),updateTimer(),currentQuestionTimerInterval&&clearInterval(currentQuestionTimerInterval),currentQuestionTimerInterval=setInterval(updateCurrentQuestionTimer,1e3),updateCurrentQuestionTimer(),await requestWakeLock()}function nextQuestion(){if(isPaused)return void showError("Vui l√≤ng ti·∫øp t·ª•c b√†i thi tr∆∞·ªõc khi chuy·ªÉn c√¢u.");if(currentQuestionIndex>totalQuestionsSet)return showError(`ƒê√£ ho√†n th√†nh ƒë·ªß ${totalQuestionsSet} c√¢u.`),void(nextQuestionButton.disabled=!0);const e=Date.now(),t=currentQuestionSeconds,o=examLabelSelect.value;if(currentExamData)currentExamData.questionTimes.push({time:t,label:o,questionNumber:currentQuestionIndex});else return void console.error("currentExamData is null when trying to save question time.");currentQuestionSeconds=0,currentQuestionTimeSpan.textContent="00:00",populateLabelDropdown(examLabelSelect,"Ch∆∞a g√°n");if(currentQuestionIndex===totalQuestionsSet)return void endExam();currentQuestionIndex++,currentQuestionNumberSpan.textContent=currentQuestionIndex,currentQuestionNumberLabel.textContent=currentQuestionIndex,questionStartTime=e,currentQuestionIndex===totalQuestionsSet?nextQuestionButton.textContent="Ho√†n th√†nh c√¢u cu·ªëi":nextQuestionButton.textContent="Ho√†n th√†nh c√¢u / B√†i ti·∫øp theo"}function confirmAndEndExam(){examStartTime>0||isPaused?confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k·∫øt th√∫c b√†i thi?")&&endExam():console.log("Kh√¥ng c√≥ b√†i thi n√†o ƒëang di·ªÖn ra ƒë·ªÉ k·∫øt th√∫c.")}async function endExam(){if(!examStartTime&&!isPaused)return void console.log("B√†i thi ƒë√£ k·∫øt th√∫c ho·∫∑c ch∆∞a b·∫Øt ƒë·∫ßu.");isExamRunning=!1,clearInterval(timerInterval),clearInterval(currentQuestionTimerInterval),timerInterval=null,currentQuestionTimerInterval=null,nextQuestionButton.disabled=!0,endExamButton.disabled=!0,pauseResumeButton.disabled=!0,examLabelSelect.disabled=!0,keepScreenOnToggle.disabled=!0;const e=isPaused?pausedTime:Date.now();if(examStartTime>0&&currentExamData&&currentExamData.questionTimes.length<currentQuestionIndex){const t=currentQuestionSeconds,o=examLabelSelect.value;currentExamData.questionTimes.some(e=>e.questionNumber===currentQuestionIndex)||(currentExamData.questionTimes.push({time:t,label:o,questionNumber:currentQuestionIndex}))}const t=examStartTime>0?Math.max(0,Math.floor((e-examStartTime-totalPauseDuration)/1e3)):0;if(currentExamData)currentExamData.totalTimeTaken=t;else return console.error("currentExamData is null when trying to finalize exam data."),showError("L·ªói: Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu b√†i thi."),void showSettings();totalSecondsSet>0?progressBar.style.width=`${Math.max(0,Math.min(100,currentExamData.totalTimeTaken/totalSecondsSet*100))}%`:progressBar.style.width="100%",await releaseWakeLock(),wakeLockControl&&wakeLockControl.classList.add("hidden"),saveExamToHistory(currentExamData),displayResults(currentExamData),hideAllSections(),resultsAreaDiv.classList.remove("hidden"),examStartTime=0,questionStartTime=0,isPaused=!1,pausedTime=0,totalPauseDuration=0,currentQuestionSeconds=0}async function togglePauseResume(){if(!examStartTime)return void showError("B√†i thi ch∆∞a b·∫Øt ƒë·∫ßu.");if(null===timerInterval&&null===currentQuestionTimerInterval&&!isPaused)return void showError("B√†i thi ƒë√£ k·∫øt th√∫c.");const e=Date.now();isPaused?(isPaused=!1,totalPauseDuration+=e-pausedTime,pausedTime=0,pauseResumeButton.textContent="T·∫°m d·ª´ng",pauseResumeButton.classList.remove("bg-green-500","hover:bg-green-600"),pauseResumeButton.classList.add("bg-yellow-500","hover:bg-yellow-600"),currentQuestionIndex<=totalQuestionsSet&&(nextQuestionButton.disabled=!1),endExamButton.disabled=!1,examLabelSelect.disabled=!1,keepScreenOnToggle.disabled=!1,updateTimer(),timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(updateTimer,1e3),updateCurrentQuestionTimer(),currentQuestionTimerInterval&&clearInterval(currentQuestionTimerInterval),currentQuestionTimerInterval=setInterval(updateCurrentQuestionTimer,1e3),await requestWakeLock()):(isPaused=!0,pausedTime=e,clearInterval(timerInterval),clearInterval(currentQuestionTimerInterval),timerInterval=null,currentQuestionTimerInterval=null,pauseResumeButton.textContent="Ti·∫øp t·ª•c",pauseResumeButton.classList.remove("bg-yellow-500","hover:bg-yellow-600"),pauseResumeButton.classList.add("bg-green-500","hover:bg-green-600"),nextQuestionButton.disabled=!0,endExamButton.disabled=!0,examLabelSelect.disabled=!0,keepScreenOnToggle.disabled=!0,await releaseWakeLock())}

        // === Filtering and Display ===
        function createLabelSelectHTML(e,t,o="label-select"){const n=getAllLabels(),s=n.includes(e)?e:"Ch∆∞a g√°n",l=getLabelStyleClasses(s);return`\n                <select class="${o} ${l.bg} ${l.text}" aria-label="${t}">\n                    ${n.map(e=>`<option value="${e}" ${s===e?"selected":""}>${e}</option>`).join("")}\n                </select>\n            `}function populateFilterDropdown(e,t){e.innerHTML="";const o=document.createElement("option");o.value=ALL_LABELS_FILTER_VALUE,o.textContent="T·∫•t c·∫£ nh√£n",e.appendChild(o);if(!t||0===t.length)return void(e.disabled=!0);const n=[...new Set(t.map(e=>e.label||"Ch∆∞a g√°n"))];n.sort((e,t)=>{if("Ch∆∞a g√°n"===e)return-1;if("Ch∆∞a g√°n"===t)return 1;const o=DEFAULT_LABELS.indexOf(e),n=DEFAULT_LABELS.indexOf(t);return o!==-1&&n!==-1?o-n:o!==-1?-1:n!==-1?1:e.localeCompare(t)}),n.forEach(t=>{if("Ch∆∞a g√°n"===t&&1===n.length)return;const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)}),e.disabled=n.length<=1&&"Ch∆∞a g√°n"===n[0],e.value=ALL_LABELS_FILTER_VALUE}function filterTableRows(e,t){e.querySelectorAll("tr").forEach(e=>{if(t===ALL_LABELS_FILTER_VALUE)e.style.display="";else{const o=e.querySelector("select"),n=o?o.value:null;e.style.display=n===t?"":"none"}})}function displayResults(e){if(!e)return showError("Kh√¥ng c√≥ d·ªØ li·ªáu k·∫øt qu·∫£ ƒë·ªÉ hi·ªÉn th·ªã."),void showSettings();resultSubjectDisplay.textContent=e.subject||"N/A",resultExamNumberDisplay.textContent=e.examNumber||"N/A",resultDateDisplay.textContent=formatDate(e.date),totalTimeTakenSpan.textContent=formatTime(e.totalTimeTaken),totalTimeSetDisplay.textContent=formatTime(e.totalTimeSet),totalQuestionsSetDisplay.textContent=e.totalQuestionsSet;const t=e.questionTimes?.length||0,o=t>0?Math.round(e.totalTimeTaken/t):0,n=e.totalQuestionsSet>0?Math.round(e.totalTimeSet/e.totalQuestionsSet):0;averageTimePerQuestionDisplay.textContent=`${formatTimeInSeconds(o)} (${o} gi√¢y)`,targetTimePerQuestionDisplay.textContent=`${formatTimeInSeconds(n)} (${n} gi√¢y)`,statsTableBody.innerHTML="",t>0?e.questionTimes.forEach(t=>{const o=t.questionNumber||"N/A",s=t.time??0,l=t.label||"Ch∆∞a g√°n",a=s-n,i=n>0?a>=0?`+${formatTimeInSeconds(a)}`:`-${formatTimeInSeconds(Math.abs(a))}`:"N/A",c=n>0?`M·ª•c ti√™u: ${formatTimeInSeconds(n)} (${n}s)`:"";let d="";n>0&&(percentDeviation=(a/n)*100)>30?d="too-slow":percentDeviation<-20&&(d="too-fast");const r=document.createElement("tr");d&&r.classList.add(d),r.dataset.examId=e.id,r.dataset.questionNumber=o;const u=createLabelSelectHTML(l,`Ch·ªçn nh√£n cho c√¢u ${o}`,"label-select");r.innerHTML=`<td>C√¢u ${o}</td><td>${formatTimeInSeconds(s)} (${s} gi√¢y)</td><td title="${c}">${i}</td><td>${u}</td>`;const m=r.querySelector(".label-select");m.addEventListener("change",t=>{const o=t.target.value,n=r.dataset.examId,s=parseInt(r.dataset.questionNumber);if(n&&!isNaN(s)){updateLabelInHistory(n,s,o);const e=getLabelStyleClasses(o);m.className=`label-select ${e.bg} ${e.text}`;const t=getExamFromHistory(n);t&&(displayStatsByLabel(t,statsByLabelArea),populateFilterDropdown(resultsFilterLabelSelect,t.questionTimes),filterTableRows(statsTableBody,resultsFilterLabelSelect.value))}}),statsTableBody.appendChild(r)}):statsTableBody.innerHTML='<tr><td colspan="4" class="text-center text-gray-500 py-3">Kh√¥ng c√≥ d·ªØ li·ªáu th·ªùi gian cho c√¢u n√†o.</td></tr>',populateFilterDropdown(resultsFilterLabelSelect,e.questionTimes),displayStatsByLabel(e,statsByLabelArea),filterTableRows(statsTableBody,ALL_LABELS_FILTER_VALUE)}function displayStatsByLabel(e,t){t.innerHTML="";if(!e||!e.questionTimes||0===e.questionTimes.length)return void(t.innerHTML='<p class="text-center text-gray-500 italic text-sm py-2">Kh√¥ng c√≥ d·ªØ li·ªáu c√¢u h·ªèi ƒë·ªÉ th·ªëng k√™.</p>');const o={};let n=0;const s=getAllLabels();s.forEach(e=>{"Ch∆∞a g√°n"!==e&&(o[e]={totalTime:0,count:0})});let l={totalTime:0,count:0};e.questionTimes.forEach(e=>{const t=e.label||"Ch∆∞a g√°n",s=e.time??0;"Ch∆∞a g√°n"===t?(l.totalTime+=s,l.count++):o[t]?(o[t].totalTime+=s,o[t].count++,n++):(l.totalTime+=s,l.count++)});if(0===n&&l.count===e.questionTimes.length)return void(t.innerHTML='<p class="text-center text-gray-500 italic text-sm py-2">G√°n nh√£n cho c√¢u h·ªèi ·ªü b·∫£ng tr√™n ƒë·ªÉ xem th·ªëng k√™.</p>');const a=[];for(const i in o)o[i].count>0&&a.push({label:i,average:Math.round(o[i].totalTime/o[i].count),count:o[i].count});a.sort((e,t)=>{const o=DEFAULT_LABELS.indexOf(e.label),n=DEFAULT_LABELS.indexOf(t.label);return o!==-1&&n!==-1?o-n:o!==-1?-1:n!==-1?1:e.label.localeCompare(t.label)}),l.count>0&&a.push({label:"Ch∆∞a g√°n",average:Math.round(l.totalTime/l.count),count:l.count}),a.forEach(e=>{const o=getLabelStyleClasses(e.label),n=document.createElement("p");n.innerHTML=`<span class="color-square ${o.bg}"></span><span class="font-medium">${e.label}:</span> Trung b√¨nh ${formatTimeInSeconds(e.average)} (${e.average} gi√¢y) / ${e.count} c√¢u`,t.appendChild(n)})}

        // === History Management ===
        function getHistory(){const e=localStorage.getItem(HISTORY_STORAGE_KEY);try{const t=e?JSON.parse(e):[],o=getAllLabels();return t.map(e=>{if(e&&e.id&&e.date&&"string"==typeof e.date){const t=new Date(e.date);if(!isNaN(t.getTime()))return e.questionTimes=Array.isArray(e.questionTimes)?e.questionTimes:[],e.questionTimes=e.questionTimes.map(t=>({...t,label:t.label&&o.includes(t.label)?t.label:"Ch∆∞a g√°n"})),{...e,date:t}}return null}).filter(e=>null!==e)}catch(t){return console.error("L·ªói ƒë·ªçc l·ªãch s·ª≠ t·ª´ localStorage:",t),showError("L·ªói ƒë·ªçc d·ªØ li·ªáu l·ªãch s·ª≠. D·ªØ li·ªáu c√≥ th·ªÉ ƒë√£ b·ªã h·ªèng."),[]}}function saveHistoryToStorage(e){try{const t=e.map(e=>({...e,date:e.date instanceof Date?e.date.toISOString():e.date}));localStorage.setItem(HISTORY_STORAGE_KEY,JSON.stringify(t))}catch(t){console.error("L·ªói l∆∞u l·ªãch s·ª≠ v√†o localStorage:",t),showError("Kh√¥ng th·ªÉ l∆∞u l·ªãch s·ª≠. B·ªô nh·ªõ tr√¨nh duy·ªát c√≥ th·ªÉ ƒë√£ ƒë·∫ßy.")}}function saveExamToHistory(e){if(!e||!e.id||!(e.date instanceof Date))return void console.error("D·ªØ li·ªáu b√†i thi kh√¥ng h·ª£p l·ªá ƒë·ªÉ l∆∞u:",e);const t=getHistory(),o=t.findIndex(t=>t.id===e.id);-1===o?t.push(e):(console.warn(`B√†i thi ID ${e.id} ƒë√£ t·ªìn t·∫°i. Ghi ƒë√® d·ªØ li·ªáu.`),t[o]=e),saveHistoryToStorage(t)}function getExamFromHistory(e){const t=getHistory(),o="string"==typeof e?Number(e):e;return isNaN(o)?null:t.find(t=>t.id===o)||null}function updateLabelInHistory(e,t,o){const n=getHistory(),s="string"==typeof e?Number(e):e;if(isNaN(s))return;const l=n.findIndex(e=>e.id===s);if(-1===l)return void console.error(`Kh√¥ng t√¨m th·∫•y b√†i thi ID ${s} trong l·ªãch s·ª≠.`);if(!Array.isArray(n[l].questionTimes))return console.error(`questionTimes kh√¥ng ph·∫£i l√† m·∫£ng cho b√†i thi ID ${s}.`),void(n[l].questionTimes=[]);const a=n[l].questionTimes.findIndex(e=>e.questionNumber===t);-1!==a?n[l].questionTimes[a].label!==o&&(n[l].questionTimes[a].label=o,saveHistoryToStorage(n)):console.warn(`Kh√¥ng t√¨m th·∫•y c√¢u ${t} trong b√†i thi ${s}, kh√¥ng th·ªÉ c·∫≠p nh·∫≠t nh√£n.`)}function deleteExamFromHistory(e){const t="string"==typeof e?Number(e):e;if(isNaN(t))return;let o=getHistory();o=o.filter(e=>e.id!==t),saveHistoryToStorage(o),console.log(`ƒê√£ x√≥a b√†i thi ID ${t} kh·ªèi l·ªãch s·ª≠.`)}function clearAllHistory(){const e=getHistory();if(0===e.length)return void showError("L·ªãch s·ª≠ ƒë√£ tr·ªëng.");confirm("‚ö†Ô∏è C·∫¢NH B√ÅO:\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò l·ªãch s·ª≠ thi kh√¥ng?\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ l∆∞u v√† KH√îNG TH·ªÇ HO√ÄN T√ÅC.")&&(localStorage.removeItem(HISTORY_STORAGE_KEY),console.log("ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠ thi."),displayHistory(),showError("ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠."))}function exportHistory(){const e=getHistory();if(0===e.length)return void showError("Kh√¥ng c√≥ l·ªãch s·ª≠ n√†o ƒë·ªÉ xu·∫•t.");const t=e.map(e=>({...e,date:e.date instanceof Date?e.date.toISOString():e.date})),o=JSON.stringify(t,null,2),n=new Blob([o],{type:"application/json;charset=utf-8"}),s=URL.createObjectURL(n),l=document.createElement("a");l.style.display="none",l.href=s;const a=(new Date).toISOString().slice(0,10);l.download=`lich_su_thi_thu_${a}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(s),showError("ƒê√£ xu·∫•t l·ªãch s·ª≠ th√†nh c√¥ng.")}
        // NEW: Populate History Subject Filter
        function populateHistorySubjectFilter(e,t){const o=e.value;e.innerHTML="";const n=document.createElement("option");n.value=ALL_SUBJECTS_FILTER_VALUE,n.textContent="T·∫•t c·∫£ m√¥n thi",e.appendChild(n);if(!t||0===t.length)return void(e.disabled=!0);const s=[...new Set(t.map(e=>e.subject).filter(e=>e))].sort((e,t)=>e.localeCompare(t));s.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,t===o&&(n.selected=!0),e.appendChild(n)}),e.disabled=s.length<=1,s.includes(o)?e.value=o:e.value=ALL_SUBJECTS_FILTER_VALUE}
        // MODIFIED displayHistory
        function displayHistory(){clearInterval(timerInterval),clearInterval(currentQuestionTimerInterval),timerInterval=null,currentQuestionTimerInterval=null,isPaused=!1,isExamRunning=!1,pausedTime=0,totalPauseDuration=0,releaseWakeLock(),hideAllSections(),historyAreaDiv.classList.remove("hidden");const e=getHistory();populateHistorySubjectFilter(historyFilterSubjectSelect,e);const t=historyFilterSubjectSelect.value;let o=e;t!==ALL_SUBJECTS_FILTER_VALUE&&(o=e.filter(e=>e.subject===t)),historyTableBody.innerHTML="",0===o.length?historyTableBody.innerHTML=`<tr><td colspan="6" class="text-center text-gray-500 py-4 italic">Kh√¥ng c√≥ l·ªãch s·ª≠ thi n√†o ${t!==ALL_SUBJECTS_FILTER_VALUE?`cho m√¥n "${t}"`:""}.</td></tr>`:(o.sort((e,t)=>t.date.getTime()-e.date.getTime()),o.forEach(e=>{const t=e.subject||"Kh√¥ng r√µ m√¥n",o=e.examNumber||"Kh√¥ng r√µ ƒë·ªÅ",n=formatDate(e.date),s=void 0!==e.totalTimeTaken&&null!==e.totalTimeTaken?formatTime(e.totalTimeTaken):"N/A",l=document.createElement("tr");l.classList.add("hover:bg-gray-50"),l.innerHTML=`\n                    <td class="whitespace-nowrap">${n}</td>\n                    <td>${t}</td>\n                    <td>${o}</td>\n                    <td class="whitespace-nowrap">${s}</td>\n                    <td><button class="text-blue-600 hover:text-blue-800 text-sm font-medium view-detail-btn" data-id="${e.id}">Xem</button></td>\n                    <td><button class="text-red-600 hover:text-red-800 text-sm font-medium delete-history-btn" data-id="${e.id}">X√≥a</button></td>\n                `,historyTableBody.appendChild(l)}))}function handleHistoryTableClick(e){const t=e.target;if(t&&t.classList.contains("view-detail-btn")){const e=t.getAttribute("data-id");e&&showHistoryDetail(e)}else if(t&&t.classList.contains("delete-history-btn")){const e=t.getAttribute("data-id");if(e){const t=getExamFromHistory(e),o=t?.subject||"N/A",n=t?.examNumber||"N/A",s=formatDate(t?.date),l=`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i thi:\n\n"${o} - ${n}"\n(L√†m ng√†y: ${s})\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;confirm(l)&&(deleteExamFromHistory(e),displayHistory(),showError("ƒê√£ x√≥a b√†i thi kh·ªèi l·ªãch s·ª≠."))}}}function showHistoryDetail(e){const t=getExamFromHistory(e);if(!t)return void showError("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho b√†i thi n√†y.");modalTitle.textContent=`Chi ti·∫øt: ${t.subject||"N/A"} - ${t.examNumber||"N/A"}`,modalSubject.textContent=t.subject||"N/A",modalExamNumber.textContent=t.examNumber||"N/A",modalDate.textContent=formatDate(t.date),modalTotalTimeTaken.textContent=formatTime(t.totalTimeTaken),modalTotalTimeSet.textContent=formatTime(t.totalTimeSet),modalTotalQuestionsSet.textContent=t.totalQuestionsSet||"N/A";const o=t.totalQuestionsSet>0&&t.totalTimeSet>=0?Math.round(t.totalTimeSet/t.totalQuestionsSet):0;modalTargetTimePerQuestion.textContent=`${formatTimeInSeconds(o)} (${o} gi√¢y)`;const n=t.questionTimes?.length||0,s=n>0?Math.round(t.totalTimeTaken/n):0;modalAverageTimePerQuestion.textContent=`${formatTimeInSeconds(s)} (${s} gi√¢y)`,modalStatsTableBody.innerHTML="",n>0?([...t.questionTimes].sort((e,t)=>(e.questionNumber||0)-(t.questionNumber||0))).forEach(e=>{const n=e.questionNumber||"N/A",s=e.time??0,l=e.label,a=s-o,i=o>0?a>=0?`+${formatTimeInSeconds(a)}`:`-${formatTimeInSeconds(Math.abs(a))}`:"N/A",c=o>0?`M·ª•c ti√™u: ${formatTimeInSeconds(o)} (${o}s)`:"",d=document.createElement("tr");d.dataset.examId=t.id,d.dataset.questionNumber=n;const r=createLabelSelectHTML(l,`Ch·ªçn nh√£n cho c√¢u ${n} trong modal`,"label-select-modal");d.innerHTML=`<td>C√¢u ${n}</td><td>${formatTimeInSeconds(s)} (${s} gi√¢y)</td><td title="${c}">${i}</td><td>${r}</td>`,modalStatsTableBody.appendChild(d)}):modalStatsTableBody.innerHTML='<tr><td colspan="4" class="text-center text-gray-500 py-3 italic">Kh√¥ng c√≥ d·ªØ li·ªáu th·ªùi gian c√¢u h·ªèi.</td></tr>',populateFilterDropdown(modalFilterLabelSelect,t.questionTimes),displayStatsByLabel(t,modalStatsByLabelArea),filterTableRows(modalStatsTableBody,ALL_LABELS_FILTER_VALUE),historyDetailModal.style.display="block",document.body.style.overflow="hidden"}function closeModal(){historyDetailModal.style.display="none",document.body.style.overflow=""}window.onclick=function(e){e.target==historyDetailModal&&closeModal()}

        // === Event Listeners ===
        startButton.addEventListener('click', startExam); viewHistoryButton.addEventListener('click', displayHistory); nextQuestionButton.addEventListener('click', nextQuestion); endExamButton.addEventListener('click', confirmAndEndExam); pauseResumeButton.addEventListener('click', togglePauseResume); restartButton.addEventListener('click', showSettings); viewHistoryFromResultsButton.addEventListener('click', displayHistory); backToSettingsButton.addEventListener('click', showSettings); exportHistoryButton.addEventListener('click', exportHistory); clearHistoryButton.addEventListener('click', clearAllHistory);
        manageLabelsButton.addEventListener('click', showLabelManagement); addLabelButton.addEventListener('click', addCustomLabel); backToSettingsFromLabelsButton.addEventListener('click', showSettings); customLabelsList.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('delete-label-btn')) { const labelToDelete = e.target.dataset.label; if (labelToDelete && confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√£n "${labelToDelete}" kh√¥ng?`)) { deleteCustomLabel(labelToDelete); } } });
        manageSubjectsButton.addEventListener('click', showSubjectManagement); addSubjectButton.addEventListener('click', addSubject); backToSettingsFromSubjectsButton.addEventListener('click', showSettings); subjectsList.addEventListener('click', handleSubjectManagementListClick);
        historyTableBody.removeEventListener('click', handleHistoryTableClick); historyTableBody.addEventListener('click', handleHistoryTableClick);
        modalStatsTableBody.addEventListener('change', (e) => { if (e.target && e.target.classList.contains('label-select-modal')) { const selectElement = e.target; const row = selectElement.closest('tr'); if (!row) return; const newLabel = selectElement.value; const examId = row.dataset.examId; const qNumber = parseInt(row.dataset.questionNumber); if (examId && !isNaN(qNumber)) { updateLabelInHistory(examId, qNumber, newLabel); const styleClasses = getLabelStyleClasses(newLabel); selectElement.className = `label-select-modal ${styleClasses.bg} ${styleClasses.text}`; const updatedExamData = getExamFromHistory(examId); if (updatedExamData) { displayStatsByLabel(updatedExamData, modalStatsByLabelArea); populateFilterDropdown(modalFilterLabelSelect, updatedExamData.questionTimes); filterTableRows(modalStatsTableBody, modalFilterLabelSelect.value); } } else { console.error("L·ªói: Kh√¥ng l·∫•y ƒë∆∞·ª£c examId ho·∫∑c questionNumber t·ª´ data attributes trong modal."); } } });
        resultsFilterLabelSelect.addEventListener('change', (e) => { filterTableRows(statsTableBody, e.target.value); });
        modalFilterLabelSelect.addEventListener('change', (e) => { filterTableRows(modalStatsTableBody, e.target.value); });
        keepScreenOnToggle.addEventListener('change', async (e) => { if (e.target.checked) { await requestWakeLock(); } else { await releaseWakeLock(); } });
        document.addEventListener('visibilitychange', handleVisibilityChange);
        historyFilterSubjectSelect.addEventListener('change', displayHistory);
        setTargetExamButton.addEventListener('click', toggleTargetExamSettings);
        saveTargetExamButton.addEventListener('click', handleSaveTargetExam);
        clearTargetExamButton.addEventListener('click', handleClearTargetExam);

        // === Initialization ===
        document.addEventListener('DOMContentLoaded', () => { showSettings(); if (!isWakeLockSupported && wakeLockControl) { wakeLockControl.style.display = 'none'; } });
    </script>
</body>
</html>
